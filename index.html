<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>YOPO AI PRO | Premium Crypto Analytics</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    :root{
      --primary:#0052ff;
      --primary-dark:#0039b3;
      --primary-light:#e6eeff;
      --secondary:#f8fbff;
      --card-bg:#ffffff;
      --text-main:#1a202c;
      --text-sub:#718096;
      --border:#e2e8f0;
      --success:#00c076;
      --danger:#ff4d4f;
      --shadow:0 4px 20px rgba(0,0,0,.05);
    }
    *{ box-sizing:border-box; }
    body{
      font-family:'Pretendard',-apple-system,BlinkMacSystemFont,system-ui,Roboto,sans-serif;
      background:var(--secondary);
      color:var(--text-main);
      margin:0;
      display:flex;
      height:100vh;
      overflow:hidden;
    }

    .sidebar{
      width:420px;
      background:var(--card-bg);
      border-right:1px solid var(--border);
      display:flex;
      flex-direction:column;
      z-index:100;
      box-shadow:4px 0 15px rgba(0,0,0,.02);
    }

    .brand-header{
      padding:26px 22px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg,#fff 0%, var(--secondary) 100%);
    }
    .brand-header h1{
      color:var(--primary);
      margin:0;
      font-size:26px;
      font-weight:900;
      letter-spacing:-1px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-badge{
      font-size:10px;
      background:var(--primary);
      color:#fff;
      padding:2px 8px;
      border-radius:4px;
      font-weight:900;
    }
    .brand-sub{
      font-size:12px;
      color:var(--text-sub);
      margin-top:6px;
      font-weight:700;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .mini-pill{
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      background:var(--primary-light);
      color:var(--primary-dark);
      font-weight:900;
      white-space:nowrap;
    }

    .stats-dashboard{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:12px;
      padding:18px 18px 16px;
      background:#fff;
      border-bottom:1px solid var(--border);
    }
    .stat-card{
      background:var(--secondary);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      text-align:center;
      transition:.2s;
    }
    .stat-card:hover{ border-color:var(--primary); transform:translateY(-1px); }
    .stat-label{ font-size:11px; color:var(--text-sub); display:block; margin-bottom:4px; font-weight:900; }
    .stat-value{ font-size:18px; font-weight:950; color:var(--primary); }

    .market-list{ flex:1; overflow-y:auto; padding:12px 14px 12px; }
    .section-title{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:0 6px 10px;
      color:var(--text-sub);
      font-size:12px;
      font-weight:900;
      gap:10px;
    }
    .section-title .right{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:900;
    }
    .status-dot{
      width:8px; height:8px; border-radius:50%;
      background:#cbd5e0;
      display:inline-block;
    }
    .status-dot.ok{ background:var(--success); }
    .status-dot.warn{ background:#f59e0b; }
    .status-dot.bad{ background:var(--danger); }

    .coin-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:16px;
      margin-bottom:10px;
      background:#fff;
      border:1px solid transparent;
      border-radius:14px;
      cursor:pointer;
      transition:.15s ease;
      box-shadow:0 2px 5px rgba(0,0,0,.01);
    }
    .coin-row:hover{ border-color:var(--border); background:var(--secondary); }
    .coin-row.active{
      border-color:var(--primary);
      background:var(--primary-light);
      box-shadow:0 4px 12px rgba(0,82,255,.15);
    }
    .coin-info h4{ margin:0; font-size:16px; font-weight:950; }
    .coin-info span{ font-size:11px; color:var(--text-sub); font-weight:800; }
    .coin-price h4{ margin:0; font-size:16px; font-weight:950; color:var(--primary); text-align:right; }
    .coin-price span{ font-size:11px; font-weight:900; display:block; text-align:right; margin-top:3px; }
    .small-metrics{ margin-top:4px; font-size:10px; color:var(--text-sub); font-weight:800; text-align:right; }

    .analysis-controls{
      padding:18px;
      background:#fff;
      border-top:1px solid var(--border);
      box-shadow:0 -5px 20px rgba(0,0,0,.03);
    }
    .tf-selector{
      display:flex;
      background:var(--secondary);
      padding:4px;
      border-radius:10px;
      margin-bottom:12px;
    }
    .tf-btn{
      flex:1;
      border:none;
      background:transparent;
      padding:10px;
      font-size:13px;
      font-weight:950;
      color:var(--text-sub);
      cursor:pointer;
      border-radius:8px;
      transition:.15s;
    }
    .tf-btn.active{
      background:#fff;
      color:var(--primary);
      box-shadow:0 2px 5px rgba(0,0,0,.05);
    }

    .btn-row{
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    .action-btn{
      width:100%;
      border:none;
      background:var(--primary);
      color:#fff;
      padding:14px 12px;
      border-radius:12px;
      font-size:14px;
      font-weight:950;
      cursor:pointer;
      transition:.2s;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      flex:1;
    }
    .action-btn:hover{ background:var(--primary-dark); transform:translateY(-1px); box-shadow:0 5px 15px rgba(0,82,255,.25); }
    .action-btn:disabled{ background:#cbd5e0; cursor:not-allowed; transform:none; box-shadow:none; }

    .action-btn.secondary{
      background:#f1f5f9;
      color:var(--text-main);
      border:1px solid var(--border);
      box-shadow:none;
    }
    .action-btn.secondary:hover{
      background:#e9eef6;
      box-shadow:none;
    }

    .tiny-note{
      margin-top:10px;
      font-size:11px;
      color:var(--text-sub);
      line-height:1.45;
      font-weight:800;
    }

    /* ì¶”ì²œ TOP */
    .recommend-box{
      margin:10px 6px 14px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
    }
    .recommend-title{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:12px;
      font-weight:950;
      color:var(--text-sub);
      margin-bottom:10px;
    }
    .rec-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      margin-bottom:8px;
      cursor:pointer;
      transition:.15s;
      background:var(--secondary);
    }
    .rec-item:hover{ border-color:var(--primary); background:var(--primary-light); }
    .rec-left{ font-weight:950; font-size:13px; }
    .rec-right{ text-align:right; font-size:11px; font-weight:950; color:var(--text-sub); }
    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:10px;
      font-weight:950;
      margin-left:8px;
      border:1px solid var(--border);
      background:#fff;
    }
    .pill.long{ color:var(--success); }
    .pill.short{ color:var(--danger); }
    .pill.hold{ color:var(--text-sub); }

    .main-panel{
      flex:1;
      display:flex;
      flex-direction:column;
      position:relative;
      background:#fff;
    }
    .chart-container{
      flex:1.45;
      background:#fff;
      border-bottom:1px solid var(--border);
      position:relative;
    }
    .tracking-dashboard{
      flex:1;
      background:var(--secondary);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      border-top:4px solid var(--primary);
    }
    .tracking-header{
      padding:14px 20px;
      background:#fff;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .tracking-header h3{
      margin:0;
      font-size:16px;
      font-weight:950;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .live-badge{
      font-size:10px;
      background:#ff4d4f;
      color:#fff;
      padding:2px 8px;
      border-radius:999px;
      animation:pulse 1.5s infinite;
      font-weight:950;
    }
    .tracking-list{ flex:1; overflow-y:auto; padding:18px; }

    .position-card{
      background:#fff;
      border-radius:16px;
      padding:18px;
      margin-bottom:14px;
      border:1px solid var(--border);
      box-shadow:0 2px 10px rgba(0,0,0,.02);
      transition:.2s;
    }
    .position-card:hover{ transform:translateY(-1px); box-shadow:0 10px 18px rgba(0,0,0,.05); }
    .card-header{ display:flex; justify-content:space-between; margin-bottom:12px; align-items:center; }
    .card-symbol{ font-size:18px; font-weight:950; }
    .card-type{
      font-size:12px;
      font-weight:950;
      padding:4px 10px;
      border-radius:999px;
    }
    .type-LONG{ background:#e6fffa; color:var(--success); }
    .type-SHORT{ background:#fff5f5; color:var(--danger); }
    .type-HOLD{ background:#f1f5f9; color:var(--text-sub); }

    .card-grid{
      display:grid;
      grid-template-columns:1fr 1.7fr 1fr;
      gap:14px;
      align-items:center;
    }
    .price-info{ text-align:center; }
    .price-label{ font-size:11px; color:var(--text-sub); display:block; font-weight:900; margin-bottom:2px; }
    .price-val{ font-size:14px; font-weight:950; }

    .progress-text{
      font-size:12px;
      font-weight:950;
      display:flex;
      justify-content:space-between;
      margin-bottom:6px;
    }
    .progress-track{
      height:10px;
      background:#edf2f7;
      border-radius:6px;
      overflow:hidden;
    }
    .progress-fill{ height:100%; transition:width .35s ease; }

    .card-foot{
      margin-top:10px;
      font-size:11px;
      color:var(--text-sub);
      font-weight:900;
      line-height:1.35;
      background:var(--secondary);
      border:1px dashed var(--border);
      border-radius:12px;
      padding:10px 12px;
    }

    .modal-overlay{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.4);
      z-index:2000;
      display:none;
      justify-content:center;
      align-items:center;
      backdrop-filter:blur(5px);
    }
    .analysis-modal{
      width:560px;
      max-width:92vw;
      background:#fff;
      border-radius:24px;
      padding:26px;
      box-shadow:0 25px 50px rgba(0,0,0,.2);
      border:1px solid var(--border);
      animation:popUp .25s cubic-bezier(.175,.885,.32,1.275);
    }
    .modal-header{
      text-align:center;
      margin-bottom:18px;
      border-bottom:1px solid var(--border);
      padding-bottom:14px;
    }
    .modal-signal{ font-size:40px; margin-bottom:8px; }
    .analysis-text{
      background:var(--secondary);
      padding:16px;
      border-radius:12px;
      font-size:13.5px;
      line-height:1.65;
      color:var(--text-main);
      margin-bottom:14px;
      border-left:4px solid var(--primary);
      font-weight:800;
    }
    .modal-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-bottom:14px;
      font-weight:950;
    }
    .mini-box{
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      text-align:left;
    }
    .mini-box small{ display:block; color:var(--text-sub); font-weight:950; margin-bottom:3px; }
    .modal-btn{
      width:100%;
      padding:14px;
      border:none;
      background:var(--primary);
      color:#fff;
      border-radius:12px;
      font-weight:950;
      cursor:pointer;
      font-size:15px;
    }
    .modal-btn.secondary{
      margin-top:8px;
      background:#f1f5f9;
      color:var(--text-main);
      border:1px solid var(--border);
    }

    .bt-box{
      margin-top:10px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      display:none;
    }
    .bt-box.show{ display:block; }
    .bt-title{ font-size:12px; font-weight:950; color:var(--text-sub); margin-bottom:8px; display:flex; justify-content:space-between; }
    .bt-metrics{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
    .bt-metrics .mini-box{ background:var(--secondary); }

    @keyframes pulse{0%{opacity:1}50%{opacity:.5}100%{opacity:1}}
    @keyframes popUp{from{transform:scale(.92);opacity:0}to{transform:scale(1);opacity:1}}
  </style>
</head>

<body>
  <div class="sidebar">
    <div class="brand-header">
      <h1><i class="fa-solid fa-layer-group"></i> YOPO AI PRO <span class="brand-badge">PREMIUM</span></h1>
      <div class="brand-sub">
        <span>KMASTER REAL-TIME CRYPTO ANALYTICS</span>
        <span class="mini-pill" id="btc-dom-pill">BTC DOM: --</span>
      </div>
    </div>

    <div class="stats-dashboard">
      <div class="stat-card">
        <span class="stat-label">ëˆ„ì  ë¶„ì„</span>
        <span class="stat-value" id="total-stat">0</span>
      </div>
      <div class="stat-card">
        <span class="stat-label">ì„±ê³µë¥ </span>
        <span class="stat-value" id="win-stat">0%</span>
      </div>
      <div class="stat-card">
        <span class="stat-label">ì¶”ì  ì¤‘</span>
        <span class="stat-value" id="active-stat">0</span>
      </div>
    </div>

    <div class="market-list">
      <div class="section-title">
        <span>ìœ ë§ ì½”ì¸ 15 (ìë™ ì„ ì •)</span>
        <span class="right">
          <span class="status-dot" id="api-dot"></span>
          <span id="universe-ts">ì—…ë°ì´íŠ¸: --</span>
        </span>
      </div>

      <!-- ì¶”ì²œ TOP -->
      <div class="recommend-box">
        <div class="recommend-title">
          <span>ì¶”ì²œ TOP (ìë™ ìŠ¤ìº” ê²°ê³¼)</span>
          <span id="scan-status" style="font-weight:950;">ëŒ€ê¸°</span>
        </div>
        <div id="rec-container">
          <div style="font-size:11px; color:var(--text-sub); font-weight:900; padding:6px 2px;">
            â€œìë™ ìŠ¤ìº”â€ì„ ëˆ„ë¥´ë©´ 15ê°œ ì½”ì¸ì„ ëŒë ¤ì„œ HOLD ì•„ë‹Œ ê²ƒë§Œ ê³¨ë¼ì¤ë‹ˆë‹¤.
          </div>
        </div>
      </div>

      <div id="market-list-container"></div>
    </div>

    <div class="analysis-controls">
      <div class="tf-selector">
        <button class="tf-btn active" onclick="setTF('60', this)">1H (ë‹¨ê¸°)</button>
        <button class="tf-btn" onclick="setTF('240', this)">4H (ì¤‘ê¸°)</button>
        <button class="tf-btn" onclick="setTF('D', this)">1D (ì¥ê¸°)</button>
      </div>

      <button class="action-btn" id="predict-btn" onclick="executeAnalysis()">
        <i class="fa-solid fa-microchip"></i> AI ë¶„ì„ ë° ì˜ˆì¸¡ ì‹¤í–‰
      </button>

      <div class="btn-row">
        <button class="action-btn secondary" id="scan-btn" onclick="autoScanUniverse()">
          <i class="fa-solid fa-magnifying-glass-chart"></i> ìë™ ìŠ¤ìº”
        </button>
        <button class="action-btn secondary" id="bt-btn" onclick="runBacktest()">
          <i class="fa-solid fa-flask"></i> ë°±í…ŒìŠ¤íŠ¸
        </button>
      </div>

      <!-- ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼ -->
      <div class="bt-box" id="bt-box">
        <div class="bt-title">
          <span>ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼(ê°„ì´)</span>
          <span id="bt-range" style="font-weight:950;">--</span>
        </div>
        <div class="bt-metrics">
          <div class="mini-box"><small>í‘œë³¸</small><div id="bt-n">--</div></div>
          <div class="mini-box"><small>ìŠ¹ë¥ </small><div id="bt-win">--</div></div>
          <div class="mini-box"><small>í‰ê· ìˆ˜ìµ(%)</small><div id="bt-avg">--</div></div>
        </div>
        <div style="margin-top:10px; font-size:11px; color:var(--text-sub); font-weight:850; line-height:1.45;">
          - ì´ ë°±í…ŒìŠ¤íŠ¸ëŠ” â€œí˜„ì¬ ë¡œì§ì„ ê³¼ê±°ì— ê·¸ëŒ€ë¡œ ì ìš©â€í–ˆì„ ë•Œì˜ ê°„ì´ ê²€ì¦ì…ë‹ˆë‹¤.<br/>
          - ì‹¤ì œ ê±°ë˜ëŠ” ìˆ˜ìˆ˜ë£Œ/ìŠ¬ë¦¬í”¼ì§€/ê¸‰ë³€ ì´ë²¤íŠ¸ ë“±ìœ¼ë¡œ ì°¨ì´ê°€ ë‚©ë‹ˆë‹¤.
        </div>
      </div>

      <div class="tiny-note">
        - ì„œë²„ ì—†ì´(HTML 1íŒŒì¼) ë™ì‘í•˜ëŠ” â€œì•ˆì •í™” ë²„ì „â€ì…ë‹ˆë‹¤.<br/>
        - ì• ë§¤í•˜ë©´ <b>ë³´ë¥˜(HOLD)</b>ë¡œ ì˜ˆì¸¡ì„ ì•ˆ í•©ë‹ˆë‹¤(ìŠ¹ë¥  ë³´í˜¸).<br/>
        - â€œì¤‘ë³µ ì‹ í˜¸/ê³¼í•œ ë¹ˆë„â€ë¥¼ ë§‰ê¸° ìœ„í•´ <b>ì¤‘ë³µ/ì¿¨ë‹¤ìš´</b> ë³´í˜¸ë¥¼ ë„£ì—ˆìŠµë‹ˆë‹¤.
      </div>
    </div>
  </div>

  <div class="main-panel">
    <div class="chart-container" id="chart-wrap"></div>

    <div class="tracking-dashboard">
      <div class="tracking-header">
        <h3><i class="fa-solid fa-radar"></i> ì‹¤ì‹œê°„ í¬ì§€ì…˜ ì •ë°€ ì¶”ì </h3>
        <span class="live-badge">LIVE</span>
      </div>
      <div class="tracking-list" id="tracking-container"></div>
    </div>
  </div>

  <div class="modal-overlay" id="result-modal">
    <div class="analysis-modal">
      <div class="modal-header">
        <div id="modal-icon" class="modal-signal">ğŸ“ˆ</div>
        <h2 id="modal-title" style="margin:0; color:var(--primary);">LONG SIGNAL</h2>
        <p id="modal-subtitle" style="margin:6px 0 0; color:var(--text-sub); font-weight:900;">BTCUSDT | 1H</p>
      </div>

      <div class="modal-grid" id="modal-grid"></div>
      <div id="modal-content" class="analysis-text"></div>

      <button class="modal-btn" id="modal-confirm" onclick="confirmTrack()">ì¶”ì  ì‹œìŠ¤í…œì— ë“±ë¡</button>
      <button class="modal-btn secondary" onclick="closeModal()">ë‹«ê¸°</button>
    </div>
  </div>

  <script src="https://s3.tradingview.com/tv.js"></script>
  <script>
    /*************************************************************
     * YOPO AI PRO (Single-File, Upgraded Edition)
     * - ì—…ê·¸ë ˆì´ë“œ: ìë™ìŠ¤ìº” / ë°±í…ŒìŠ¤íŠ¸ / ì¤‘ë³µ&ì¿¨ë‹¤ìš´ ë³´í˜¸ / ì§€í‘œ ê°•í™”
     * - ì£¼ì˜: ì´ ì½”ë“œëŠ” â€œìˆ˜ìµ ë³´ì¥â€ì´ ì•„ë‹ˆë¼ â€œë¶„ì„/ê²€ì¦/ì¶”ì â€ ë„êµ¬ì…ë‹ˆë‹¤.
     *************************************************************/

    // ---------- Storage ----------
    const STORAGE_KEY = "yopo_single_v5_state";

    // ---------- API ----------
    const BYBIT_TICKERS = "https://api.bybit.com/v5/market/tickers?category=linear";
    const BYBIT_KLINE = (symbol, interval, limit) =>
      `https://api.bybit.com/v5/market/kline?category=linear&symbol=${encodeURIComponent(symbol)}&interval=${encodeURIComponent(interval)}&limit=${limit}`;

    const CG_MARKETS = "https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=200&page=1&sparkline=false&price_change_percentage=24h";
    const CG_GLOBAL  = "https://api.coingecko.com/api/v3/global";

    // ---------- Similarity / Analysis Params ----------
    const SIM_WINDOW = 40;      // íŒ¨í„´ ê¸¸ì´(ìº”ë“¤)
    const FUTURE_H = 8;         // ê³¼ê±° íŒ¨í„´ ì´í›„ ëª‡ ìº”ë“¤ ë’¤ ë°©í–¥ í™•ì¸
    const SIM_STEP = 2;         // ìŠ¤ìº” ê°„ê²©
    const SIM_TOPK = 25;        // ìƒìœ„ ìœ ì‚¬ íŒ¨í„´ ê°œìˆ˜

    // HOLD(ë³´ë¥˜) ê·œì¹™(ìŠ¹ë¥  ë³´í˜¸)
    const HOLD_MIN_TOPK = 12;
    const HOLD_MIN_SIM_AVG = 55;
    const HOLD_MIN_EDGE = 0.08;
    const HOLD_MIN_TP_PCT = 0.8;

    // TP/SL (ATR ê¸°ë°˜)
    const RR = 2.0;
    const TF_MULT = { "60": 1.2, "240": 2.0, "D": 3.5 };
    const ATR_MIN_PCT = 0.15;
    const TP_MAX_PCT = 20.0;

    // ì¿¨ë‹¤ìš´(ê°™ì€ ì½”ì¸/TFì—ì„œ ë„ˆë¬´ ì¦ì€ ì‹ í˜¸ ë°©ì§€)
    const COOLDOWN_MS = { "60": 10 * 60 * 1000, "240": 30 * 60 * 1000, "D": 2 * 60 * 60 * 1000 };

    // ìë™ìŠ¤ìº”: API ë¶€ë‹´ ì¤„ì´ê¸° ìœ„í•œ ë”œë ˆì´(ë ˆì´íŠ¸ë¦¬ë°‹ ì˜ˆë°©)
    const SCAN_DELAY_MS = 650;

    // ë°±í…ŒìŠ¤íŠ¸ ìƒ˜í”Œ ìˆ˜(ìµœê·¼ Nê°œ ìº”ë“¤ ê¸°ë°˜ ìŠ¬ë¼ì´ë”©)
    const BACKTEST_TRADES = 60;

    // "í™•ì¥ íˆìŠ¤í† ë¦¬" (ë¸Œë¼ìš°ì €ì—ì„œ ê°€ëŠ¥í•œ ì„ )
    // ì°¸ê³ : ì„œë²„ ì—†ì´ "ì „ì²´ ì°¨íŠ¸(ìˆ˜ë…„ì¹˜)"ëŠ” API ì œí•œ/ë ˆì´íŠ¸ë¦¬ë°‹ ë•Œë¬¸ì— í˜„ì‹¤ì ìœ¼ë¡œ ë¶ˆê°€.
    const EXTENDED_LIMIT = 900; // 420ë³´ë‹¤ ë„‰ë„‰ (ë¸Œë¼ìš°ì € í•œ ë²ˆ í˜¸ì¶œë¡œ ì•ˆì •ì ìœ¼ë¡œ ì²˜ë¦¬ ê°€ëŠ¥í•œ ìˆ˜ì¤€)

    // ---------- Candidate List (ê¸°ë³¸ 15) ----------
    const DEFAULT_CANDIDATES = [
      { s: "BTCUSDT", n: "ë¹„íŠ¸ì½”ì¸", cg: "bitcoin" },
      { s: "ETHUSDT", n: "ì´ë”ë¦¬ì›€", cg: "ethereum" },
      { s: "SOLUSDT", n: "ì†”ë¼ë‚˜", cg: "solana" },
      { s: "XRPUSDT", n: "ë¦¬í”Œ", cg: "ripple" },
      { s: "ADAUSDT", n: "ì—ì´ë‹¤", cg: "cardano" },
      { s: "DOGEUSDT", n: "ë„ì§€ì½”ì¸", cg: "dogecoin" },
      { s: "AVAXUSDT", n: "ì•„ë°œë€ì²´", cg: "avalanche-2" },
      { s: "DOTUSDT", n: "í´ì¹´ë‹·", cg: "polkadot" },
      { s: "LINKUSDT", n: "ì²´ì¸ë§í¬", cg: "chainlink" },
      { s: "POLUSDT", n: "í´ë¦¬ê³¤", cg: "polygon-ecosystem-token" },
      { s: "TRXUSDT", n: "íŠ¸ë¡ ", cg: "tron" },
      { s: "BCHUSDT", n: "ë¹„íŠ¸ì½”ì¸ìºì‹œ", cg: "bitcoin-cash" },
      { s: "NEARUSDT", n: "ë‹ˆì–´í”„ë¡œí† ì½œ", cg: "near" },
      { s: "LTCUSDT", n: "ë¼ì´íŠ¸ì½”ì¸", cg: "litecoin" },
      { s: "APTUSDT", n: "ì•±í† ìŠ¤", cg: "aptos" }
    ];

    // ---------- State ----------
    let state = loadState() || {
      symbol: "BTCUSDT",
      tf: "60",
      universe: DEFAULT_CANDIDATES.map(x => ({...x})),
      activePositions: [],
      history: { total: 0, win: 0 },
      lastUniverseAt: 0,
      btcDom: null,
      btcDomPrev: null,
      lastApiHealth: "warn",
      lastSignalAt: {},       // key: symbol|tf -> timestamp
      lastScanAt: 0,
      lastScanResults: []     // [{symbol, tf, type, winProb, edge}]
    };

    let tempPos = null;

    // ---------- Boot ----------
    document.addEventListener("DOMContentLoaded", async () => {
      initChart();
      renderUniverseList();
      renderTrackingList();
      updateStatsUI();
      renderScanResults();

      await refreshUniverseAndGlobals();
      await marketTick();

      setInterval(marketTick, 2000);
      setInterval(refreshUniverseAndGlobals, 60000);
    });

    // ---------- UI ----------
    function setTF(tf, btn){
      state.tf = tf;
      document.querySelectorAll(".tf-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      saveState();
      initChart();
    }

    function switchCoin(symbol){
      state.symbol = symbol;
      document.querySelectorAll(".coin-row").forEach(r => r.classList.remove("active"));
      const row = document.getElementById(`row-${symbol}`);
      if(row) row.classList.add("active");
      saveState();
      initChart();
    }

    // ---------- Chart ----------
    function initChart(){
      document.getElementById("chart-wrap").innerHTML = "";
      new TradingView.widget({
        autosize:true,
        symbol:"BYBIT:" + state.symbol,
        interval:state.tf,
        timezone:"Asia/Seoul",
        theme:"light",
        style:"1",
        locale:"ko",
        toolbar_bg:"#f1f3f6",
        enable_publishing:false,
        hide_top_toolbar:false,
        container_id:"chart-wrap"
      });
    }

    // ---------- Universe + Dominance ----------
    async function refreshUniverseAndGlobals(){
      const apiDot = document.getElementById("api-dot");
      try{
        const g = await fetchJSON(CG_GLOBAL, { timeoutMs: 6000, retry: 1 });
        const dom = g?.data?.market_cap_percentage?.btc;
        if(typeof dom === "number"){
          state.btcDomPrev = (typeof state.btcDom === "number") ? state.btcDom : null;
          state.btcDom = dom;
          document.getElementById("btc-dom-pill").innerText = `BTC DOM: ${dom.toFixed(1)}%`;
        }

        const markets = await fetchJSON(CG_MARKETS, { timeoutMs: 7000, retry: 1 });

        const enriched = DEFAULT_CANDIDATES.map(c => {
          const m = Array.isArray(markets) ? markets.find(x => x.id === c.cg) : null;
          const mc = m?.market_cap ?? 0;
          const vol = m?.total_volume ?? 0;
          const chg = m?.price_change_percentage_24h ?? 0;
          const score =
            safeLog10(mc) * 0.45 +
            safeLog10(vol) * 0.45 +
            Math.min(Math.abs(chg), 20) * 0.10;
          return { ...c, mc, vol, chg, score };
        }).sort((a,b)=> b.score - a.score);

        state.universe = enriched.slice(0, 15);
        state.lastUniverseAt = Date.now();
        state.lastApiHealth = "ok";
        saveState();

        document.getElementById("universe-ts").innerText = `ì—…ë°ì´íŠ¸: ${new Date(state.lastUniverseAt).toLocaleTimeString()}`;
        apiDot.className = "status-dot ok";
        renderUniverseList();
      }catch(e){
        console.warn("CoinGecko unavailable -> fallback to Bybit universe", e);
        apiDot.className = "status-dot warn";
        state.lastApiHealth = "warn";
        saveState();
        await fallbackUniverseFromBybit();
      }
    }

    async function fallbackUniverseFromBybit(){
      try{
        const json = await fetchJSON(BYBIT_TICKERS, { timeoutMs: 7000, retry: 1 });
        const tickers = json?.result?.list || [];

        const rows = tickers
          .map(t => {
            const symbol = t.symbol;
            const last = parseFloat(t.lastPrice || "0");
            const chg = parseFloat(t.price24hPcnt || "0") * 100;
            const turn =
              parseFloat(t.turnover24h || "0") ||
              parseFloat(t.turnover || "0") ||
              parseFloat(t.volume24h || "0") ||
              parseFloat(t.volume || "0") || 0;
            return { symbol, last, chg, turn };
          })
          .filter(x => x.symbol && x.symbol.endsWith("USDT") && x.last > 0);

        rows.sort((a,b)=> (b.turn - a.turn));
        const top = rows.slice(0, 60);

        const baseSet = new Set(DEFAULT_CANDIDATES.map(x=>x.s));
        const picked = [];

        for(const r of top){
          if(picked.length >= 15) break;
          if(baseSet.has(r.symbol)){
            const base = DEFAULT_CANDIDATES.find(x=>x.s===r.symbol);
            picked.push({ ...base, chg: r.chg, turn: r.turn, score: safeLog10(r.turn) });
          }
        }
        for(const r of top){
          if(picked.length >= 15) break;
          if(picked.some(x=>x.s===r.symbol)) continue;
          picked.push({ s: r.symbol, n: r.symbol.replace("USDT",""), cg: null, chg: r.chg, turn: r.turn, score: safeLog10(r.turn) });
        }

        state.universe = picked.slice(0, 15);
        state.lastUniverseAt = Date.now();
        saveState();

        document.getElementById("universe-ts").innerText = `ì—…ë°ì´íŠ¸: ${new Date(state.lastUniverseAt).toLocaleTimeString()}`;
        renderUniverseList();
      }catch(e){
        console.error("Bybit fallback universe failed:", e);
      }
    }

    function renderUniverseList(){
      const container = document.getElementById("market-list-container");
      container.innerHTML = "";
      state.universe.forEach(coin => {
        const div = document.createElement("div");
        div.className = `coin-row ${coin.s === state.symbol ? "active" : ""}`;
        div.id = `row-${coin.s}`;
        div.onclick = () => switchCoin(coin.s);
        div.innerHTML = `
          <div class="coin-info">
            <h4>${coin.s.replace("USDT","")}</h4>
            <span>${coin.n || "-"}</span>
          </div>
          <div class="coin-price" id="price-${coin.s}">
            <h4>---</h4><span>---</span>
            <div class="small-metrics" id="meta-${coin.s}"></div>
          </div>
        `;
        container.appendChild(div);

        const meta = document.getElementById(`meta-${coin.s}`);
        if(meta){
          const mcTxt = coin.mc ? `ì‹œì´ ${formatMoney(coin.mc)}` : "";
          const volTxt = coin.vol ? `ê±°ë˜ëŸ‰ ${formatMoney(coin.vol)}` : "";
          const turnTxt = coin.turn ? `ìœ ë™ì„± ${formatMoney(coin.turn)}` : "";
          const chgTxt = (typeof coin.chg === "number") ? `24h ${coin.chg.toFixed(1)}%` : "";
          meta.innerText = [mcTxt, volTxt, turnTxt, chgTxt].filter(Boolean).join(" Â· ");
        }
      });
    }

    // ---------- Market tick + tracking ----------
    async function marketTick(){
      try{
        const json = await fetchJSON(BYBIT_TICKERS, { timeoutMs: 7000, retry: 1 });
        const tickers = json?.result?.list || [];
        const symbols = new Set(state.universe.map(x => x.s));

        for(const t of tickers){
          if(!symbols.has(t.symbol)) continue;
          const price = parseFloat(t.lastPrice || "0");
          const chg = parseFloat(t.price24hPcnt || "0") * 100;
          if(price > 0) updateCoinRow(t.symbol, price, chg);
          if(price > 0) trackPositions(t.symbol, price);
        }

        if(!symbols.has(state.symbol) && state.universe[0]){
          switchCoin(state.universe[0].s);
        }
      }catch(e){
        console.error("Market tick error:", e);
        document.getElementById("api-dot").className = "status-dot bad";
      }
    }

    function updateCoinRow(symbol, price, changePct){
      const el = document.getElementById(`price-${symbol}`);
      if(!el) return;
      const color = changePct >= 0 ? "var(--success)" : "var(--danger)";
      const sign = changePct >= 0 ? "+" : "";
      el.querySelector("h4").innerHTML = `<span style="color:${color}">$${price.toLocaleString(undefined,{maximumFractionDigits:6})}</span>`;
      el.querySelector("span").innerHTML = `<span style="color:${color}">${sign}${changePct.toFixed(2)}%</span>`;
    }

    // ---------- Core Analysis (Upgraded) ----------
    async function executeAnalysis(){
      const btn = document.getElementById("predict-btn");
      btn.disabled = true;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ë¶„ì„ ì¤‘...';

      try{
        // ì¤‘ë³µ/ì¿¨ë‹¤ìš´ ë³´í˜¸
        const dupKey = `${state.symbol}|${state.tf}`;
        if(hasActivePosition(state.symbol, state.tf)){
          alert("ì´ë¯¸ ê°™ì€ ì½”ì¸/ê°™ì€ ê¸°ê°„ì˜ ì¶”ì  í¬ì§€ì…˜ì´ ìˆìŠµë‹ˆë‹¤. (ì¤‘ë³µ ë°©ì§€)");
          return;
        }
        if(isInCooldown(dupKey)){
          alert("ë„ˆë¬´ ìì£¼ ì‹ í˜¸ë¥¼ ë‚´ë©´ ìŠ¹ë¥ ì´ ë‚´ë ¤ê°ˆ ìˆ˜ ìˆì–´ìš”. ì§€ê¸ˆì€ ì¿¨ë‹¤ìš´ì…ë‹ˆë‹¤.");
          return;
        }

        const candles = await fetchCandles(state.symbol, state.tf, EXTENDED_LIMIT);
        if(candles.length < (SIM_WINDOW + FUTURE_H + 80)) throw new Error("ìº”ë“¤ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");

        const pos = buildSignalFromCandles(state.symbol, state.tf, candles);

        // ì¿¨ë‹¤ìš´ timestamp ê¸°ë¡(ì‹ í˜¸ ìƒì„± ì‹œì )
        state.lastSignalAt[dupKey] = Date.now();
        saveState();

        showResultModal(pos);
      }catch(e){
        console.error(e);
        alert("ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (API ì§€ì—°/ì œí•œ ê°€ëŠ¥)");
      }finally{
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-microchip"></i> AI ë¶„ì„ ë° ì˜ˆì¸¡ ì‹¤í–‰';
      }
    }

    function buildSignalFromCandles(symbol, tf, candles){
      const closes = candles.map(x => x.c);
      const highs  = candles.map(x => x.h);
      const lows   = candles.map(x => x.l);
      const vols   = candles.map(x => x.v);

      const entry = closes[closes.length - 1];

      // indicators
      const rsi = calcRSI(closes, 14);
      const macd = calcMACD(closes);
      const atrRaw = calcATR(highs, lows, closes, 14);
      const volTrend = calcVolumeTrend(vols, 20);
      const ema20 = emaLast(closes, 20);
      const ema50 = emaLast(closes, 50);
      const trend = (ema20 >= ema50) ? 1 : -1; // ê°„ë‹¨ ì¶”ì„¸ ë°©í–¥

      // similarity
      const sim = calcSimilarityStats(closes, SIM_WINDOW, FUTURE_H, SIM_STEP, SIM_TOPK);

      // dominance logic (ë³´ìˆ˜ì  í•„í„°)
      const dom = (typeof state.btcDom === "number") ? state.btcDom : null;
      const domPrev = (typeof state.btcDomPrev === "number") ? state.btcDomPrev : null;
      const domUp = (dom !== null && domPrev !== null) ? (dom - domPrev) : 0;

      // ì•ŒíŠ¸ì½”ì¸ì€ BTC DOMì´ ë†’ê±°ë‚˜ ìƒìŠ¹ì¤‘ì´ë©´ ë³´ìˆ˜ì ìœ¼ë¡œ
      const isAlt = (symbol !== "BTCUSDT");
      let domDamp = 1.0;
      let domHoldBoost = 0.0;
      if(dom !== null){
        if(dom > 50) domDamp *= 0.88;
        if(domUp > 0.15) { domDamp *= 0.85; domHoldBoost += 1; }
        if(isAlt && dom > 53) { domDamp *= 0.82; domHoldBoost += 1; }
      }

      // base probs from similarity
      let longP = sim.longProb;
      let shortP = sim.shortProb;

      // indicator biases (ê²°ì •ë¡ ì , ëœë¤ ì—†ìŒ)
      const rsiBias = clamp((50 - rsi) / 50, -1, 1);       // rsi ë‚®ìœ¼ë©´ long ìª½
      const macdBias = clamp(macd.hist * 6, -1, 1);        // hist ì–‘ì´ë©´ long ìª½
      const volBias = clamp(volTrend, -1, 1);              // ê±°ë˜ëŸ‰ ì¦ê°€ë©´ ì‹ ë¢°â†‘
      const trendBias = clamp(trend * 0.8, -1, 1);         // ì¶”ì„¸ ë°©í–¥

      // combine
      longP  += (0.12 * rsiBias) + (0.10 * macdBias) + (0.06 * volBias) + (0.08 * trendBias);
      shortP += (-0.12 * rsiBias) + (-0.10 * macdBias) + (-0.06 * volBias) + (-0.08 * trendBias);

      // dominance damp (ì‹ ë¢°ë„ ë³´ìˆ˜í™”)
      longP  = 0.5 + (longP - 0.5) * domDamp;
      shortP = 0.5 + (shortP - 0.5) * domDamp;

      // normalize
      const sum = Math.max(longP + shortP, 1e-9);
      longP /= sum; shortP /= sum;

      const type = (longP >= shortP) ? "LONG" : "SHORT";
      const winProb = Math.max(longP, shortP);
      const edge = Math.abs(longP - shortP);

      // TP/SL from ATR
      const tfMult = TF_MULT[tf] || 1.2;
      const atrMin = entry * (ATR_MIN_PCT / 100);
      const atrUsed = Math.max(atrRaw, atrMin);

      let tpDist = atrUsed * tfMult;
      let slDist = tpDist / RR;

      let tp = (type === "LONG") ? (entry + tpDist) : (entry - tpDist);
      let sl = (type === "LONG") ? (entry - slDist) : (entry + slDist);

      let tpPct = Math.abs((tp - entry) / entry) * 100;
      let slPct = Math.abs((sl - entry) / entry) * 100;

      if(tpPct > TP_MAX_PCT){
        tpPct = TP_MAX_PCT;
        const newTpDist = entry * (tpPct/100);
        tp = (type === "LONG") ? (entry + newTpDist) : (entry - newTpDist);
        sl = (type === "LONG") ? (entry - (newTpDist/RR)) : (entry + (newTpDist/RR));
        slPct = Math.abs((sl - entry) / entry) * 100;
      }

      // HOLD rules (ìŠ¹ë¥  ë³´í˜¸)
      const holdReasons = [];
      if(sim.count < HOLD_MIN_TOPK) holdReasons.push(`ìœ ì‚¬íŒ¨í„´ í‘œë³¸ ë¶€ì¡±(${sim.count}ê°œ)`);
      if(sim.avgSim < HOLD_MIN_SIM_AVG) holdReasons.push(`ìœ ì‚¬ë„ í‰ê·  ë‚®ìŒ(${sim.avgSim.toFixed(1)}%)`);
      if(edge < HOLD_MIN_EDGE) holdReasons.push(`ë¡±/ìˆ ì°¨ì´ ì‘ìŒ(ì—£ì§€ ${(edge*100).toFixed(1)}%)`);
      if(tpPct < HOLD_MIN_TP_PCT) holdReasons.push(`ëª©í‘œìˆ˜ìµ ë„ˆë¬´ ì‘ìŒ(+${tpPct.toFixed(2)}%)`);

      // DOMì´ ë¶ˆë¦¬í•˜ë©´(íŠ¹íˆ ì•ŒíŠ¸) ë³´ë¥˜ ê°•í™”
      if(domHoldBoost >= 2 && isAlt) holdReasons.push(`BTC ë„ë¯¸ë„ŒìŠ¤ í™˜ê²½ì´ ì•ŒíŠ¸ì— ë¶ˆë¦¬(ë³´ìˆ˜ì )`);
      if(volTrend < -0.25) holdReasons.push(`ê±°ë˜ëŸ‰ íë¦„ ì•½í•¨(ì‹ ë¢°â†“)`);

      const isHold = holdReasons.length > 0;

      return {
        id: Date.now(),
        symbol,
        tf: tf === "60" ? "1H" : tf === "240" ? "4H" : "1D",
        tfRaw: tf,
        type: isHold ? "HOLD" : type,
        entry,
        tp: isHold ? null : tp,
        sl: isHold ? null : sl,
        tpPct: isHold ? null : tpPct,
        slPct: isHold ? null : slPct,
        createdAt: Date.now(),
        explain: {
          winProb,
          longP, shortP,
          edge,
          simAvg: sim.avgSim,
          simCount: sim.count,
          simLongPct: sim.longProb * 100,
          simShortPct: sim.shortProb * 100,
          rsi,
          macdHist: macd.hist,
          atr: atrUsed,
          volTrend,
          ema20, ema50,
          trend,
          btcDom: dom,
          btcDomUp: domUp,
          holdReasons
        }
      };
    }

    // ---------- Modal ----------
    function showResultModal(pos){
      tempPos = pos;

      const modal = document.getElementById("result-modal");
      const icon = document.getElementById("modal-icon");
      const title = document.getElementById("modal-title");
      const subtitle = document.getElementById("modal-subtitle");
      const grid = document.getElementById("modal-grid");
      const content = document.getElementById("modal-content");
      const confirmBtn = document.getElementById("modal-confirm");

      const isLong = pos.type === "LONG";
      const isShort = pos.type === "SHORT";
      const isHold = pos.type === "HOLD";

      icon.textContent = isHold ? "â¸ï¸" : (isLong ? "ğŸ“ˆ" : "ğŸ“‰");
      title.textContent = isHold ? "HOLD (ë³´ë¥˜)" : `${pos.type} SIGNAL`;
      title.style.color = isHold ? "var(--text-sub)" : (isLong ? "var(--success)" : "var(--danger)");
      subtitle.textContent = `${pos.symbol} | ${pos.tf}`;

      const ex = pos.explain;

      if(isHold){
        grid.innerHTML = `
          <div class="mini-box"><small>íŒì •</small><div>ì´ë²ˆì—ëŠ” ì˜ˆì¸¡ ì•ˆ í•¨</div></div>
          <div class="mini-box"><small>ì´ìœ </small><div>í™•ì‹  ë¶€ì¡±</div></div>
          <div class="mini-box"><small>ìœ ì‚¬ë„ í‰ê· </small><div>${ex.simAvg.toFixed(1)}%</div></div>
          <div class="mini-box"><small>í‘œë³¸ ìˆ˜</small><div>${ex.simCount}ê°œ</div></div>
        `;
        const reasons = ex.holdReasons.map(r => `- ${r}`).join("<br/>");
        content.innerHTML = `
          <b>ì´ë²ˆì—ëŠ” â€œë³´ë¥˜â€ê°€ ë” ì•ˆì „í•´ìš”.</b><br/>
          ${reasons}<br/><br/>
          <b>ì •ë¦¬:</b> ì• ë§¤í•  ë•Œ ì–µì§€ë¡œ ì§„ì…í•˜ë©´ ì¥ê¸° ìŠ¹ë¥ ì´ ë‚´ë ¤ê°€ì„œ, ì´ë²ˆì€ íŒ¨ìŠ¤í•©ë‹ˆë‹¤.
        `;
        confirmBtn.disabled = true;
        confirmBtn.textContent = "ë³´ë¥˜ëŠ” ë“±ë¡í•˜ì§€ ì•ŠìŒ";
      }else{
        grid.innerHTML = `
          <div class="mini-box"><small>ì§„ì…ê°€</small><div>$${pos.entry.toLocaleString(undefined,{maximumFractionDigits:6})}</div></div>
          <div class="mini-box"><small>ì„±ê³µí™•ë¥ (ì¶”ì •)</small><div>${(ex.winProb*100).toFixed(1)}%</div></div>
          <div class="mini-box"><small>ëª©í‘œê°€(TP)</small><div style="color:var(--success)">$${pos.tp.toLocaleString(undefined,{maximumFractionDigits:6})} (+${pos.tpPct.toFixed(2)}%)</div></div>
          <div class="mini-box"><small>ì†ì ˆê°€(SL)</small><div style="color:var(--danger)">$${pos.sl.toLocaleString(undefined,{maximumFractionDigits:6})} (-${pos.slPct.toFixed(2)}%)</div></div>
        `;

        const simMsg = `ìœ ì‚¬íŒ¨í„´ ${ex.simCount}ê°œ ì¤‘ ${pos.type==="LONG"?"ìƒìŠ¹":"í•˜ë½"}ì´ ${(pos.type==="LONG"?ex.simLongPct:ex.simShortPct).toFixed(1)}% (í‰ê·  ìœ ì‚¬ë„ ${ex.simAvg.toFixed(1)}%)`;
        const rsiMsg = `RSI ${ex.rsi.toFixed(1)} (${ex.rsi < 45 ? "ë‚®ìŒâ†’ë°˜ë“± ê°€ëŠ¥" : ex.rsi > 55 ? "ë†’ìŒâ†’ì¡°ì • ê°€ëŠ¥" : "ì¤‘ê°„â†’ë°©í–¥ ì•½í•¨"})`;
        const macdMsg = `MACD í˜ ${ex.macdHist.toFixed(4)} (${ex.macdHist >= 0 ? "ìƒìŠ¹ ìª½" : "í•˜ë½ ìª½"})`;
        const trendMsg = `ì¶”ì„¸(EMA20/EMA50) ${ex.ema20 >= ex.ema50 ? "ìƒìŠ¹ ìš°ìœ„" : "í•˜ë½ ìš°ìœ„"}`;
        const volMsg = `ê±°ë˜ëŸ‰ íë¦„ ${ex.volTrend >= 0 ? "ì¦ê°€(ì‹ ë¢°â†‘)" : "ê°ì†Œ(ì‹ ë¢°â†“)"}`;
        const domMsg = (typeof ex.btcDom === "number")
          ? `BTC ë„ë¯¸ë„ŒìŠ¤ ${ex.btcDom.toFixed(1)}% (ìµœê·¼ ë³€í™” ${ex.btcDomUp>=0?"+":""}${ex.btcDomUp.toFixed(2)}p)`
          : `BTC ë„ë¯¸ë„ŒìŠ¤: ë°ì´í„° ì—†ìŒ`;
        const edgeMsg = `ë¡±/ìˆ ì°¨ì´(ì—£ì§€) ${(ex.edge*100).toFixed(1)}%`;

        content.innerHTML = `
          <b>ì™œ ${pos.type}ëƒë©´ìš”:</b><br/>
          1) <b>ê³¼ê±° ìœ ì‚¬íŒ¨í„´ í†µê³„</b>ê°€ í•µì‹¬ ê·¼ê±°ì˜ˆìš”.<br/>- ${simMsg}<br/><br/>
          2) <b>ë³´ì¡°ì§€í‘œë¡œ í™•ì¸</b>í–ˆì–´ìš”.<br/>
          - ${rsiMsg}<br/>
          - ${macdMsg}<br/>
          - ${trendMsg}<br/>
          - ${volMsg}<br/>
          - ${domMsg}<br/>
          - ${edgeMsg}<br/><br/>
          <b>ì •ë¦¬:</b> â€œìœ ì‚¬ë„ í†µê³„ + ì§€í‘œâ€ê°€ ê°™ì€ ë°©í–¥ì´ë¼ ${pos.type}ë¡œ ì œì•ˆí•©ë‹ˆë‹¤.
        `;

        confirmBtn.disabled = false;
        confirmBtn.textContent = "ì¶”ì  ì‹œìŠ¤í…œì— ë“±ë¡";
      }

      modal.style.display = "flex";
    }

    function closeModal(){
      document.getElementById("result-modal").style.display = "none";
      tempPos = null;
    }

    function confirmTrack(){
      if(!tempPos) return;
      if(tempPos.type === "HOLD") return;

      // ì¤‘ë³µ ë°©ì§€(ì•ˆì „)
      if(hasActivePosition(tempPos.symbol, tempPos.tfRaw)){
        alert("ì´ë¯¸ ê°™ì€ ì½”ì¸/ê°™ì€ ê¸°ê°„ì˜ ì¶”ì  í¬ì§€ì…˜ì´ ìˆìŠµë‹ˆë‹¤.");
        return;
      }

      state.activePositions.unshift({
        ...tempPos,
        status: "ACTIVE",
        lastPrice: tempPos.entry,
        pnl: 0
      });
      saveState();
      closeModal();
      renderTrackingList();
      updateStatsUI();
    }

    // ---------- Tracking ----------
    function trackPositions(symbol, currentPrice){
      let changed = false;

      for(let i = state.activePositions.length - 1; i >= 0; i--){
        const pos = state.activePositions[i];
        if(pos.symbol !== symbol) continue;

        pos.lastPrice = currentPrice;

        let pnl = 0;
        if(pos.type === "LONG"){
          pnl = ((currentPrice - pos.entry) / pos.entry) * 100;
        }else{
          pnl = ((pos.entry - currentPrice) / pos.entry) * 100;
        }
        pos.pnl = pnl;

        let close = false;
        let win = false;

        if(pos.type === "LONG"){
          if(currentPrice >= pos.tp){ close = true; win = true; }
          else if(currentPrice <= pos.sl){ close = true; win = false; }
        }else{
          if(currentPrice <= pos.tp){ close = true; win = true; }
          else if(currentPrice >= pos.sl){ close = true; win = false; }
        }

        if(close){
          state.history.total++;
          if(win) state.history.win++;
          state.activePositions.splice(i, 1);
          saveState();
          changed = true;

          alert(`[${pos.symbol}] ì¢…ë£Œ: ${win ? "ì„±ê³µ(ìˆ˜ìµ)" : "ì‹¤íŒ¨(ì†ì ˆ)"} / ìˆ˜ìµë¥  ${pnl.toFixed(2)}%`);
        }else{
          changed = true;
        }
      }

      if(changed){
        saveState();
        renderTrackingList();
        updateStatsUI();
      }
    }

    function renderTrackingList(){
      const container = document.getElementById("tracking-container");

      if(!state.activePositions.length){
        container.innerHTML = `
          <div style="text-align:center; padding:50px; color:var(--text-sub); font-weight:950;">
            <i class="fa-solid fa-radar" style="font-size:44px; opacity:.18;"></i><br><br>
            í˜„ì¬ ì¶”ì  ì¤‘ì¸ í¬ì§€ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.<br/>
            ì™¼ìª½ì—ì„œ ì½”ì¸ì„ ê³ ë¥´ê³  â€œAI ë¶„ì„â€ì„ ëˆŒëŸ¬ë³´ì„¸ìš”.
          </div>
        `;
        return;
      }

      container.innerHTML = state.activePositions.map(pos => {
        const isUp = pos.pnl >= 0;
        const color = isUp ? "var(--success)" : "var(--danger)";

        const denom = Math.max(Math.abs(pos.tp - pos.entry), 1e-9);
        const numer = (pos.type === "LONG")
          ? (pos.lastPrice - pos.entry)
          : (pos.entry - pos.lastPrice);

        let progress = (numer / denom) * 100;
        progress = clamp(progress, 0, 100);

        const ex = pos.explain || {};
        const explainLine =
          `ìœ ì‚¬íŒ¨í„´ ${ex.simCount ?? "-"}ê°œ Â· ìœ ì‚¬ë„ ${(ex.simAvg ?? 0).toFixed ? ex.simAvg.toFixed(1) : "-"}% Â· RSI ${(ex.rsi ?? 0).toFixed ? ex.rsi.toFixed(1) : "-"} Â· ì—£ì§€ ${((ex.edge ?? 0)*100).toFixed ? ((ex.edge ?? 0)*100).toFixed(1) : "-"}%`;

        return `
          <div class="position-card">
            <div class="card-header">
              <div class="card-symbol">
                ${pos.symbol} <span style="font-size:12px; color:var(--text-sub); font-weight:950;">${pos.tf}</span>
              </div>
              <div class="card-type ${pos.type === "LONG" ? "type-LONG" : "type-SHORT"}">${pos.type}</div>
            </div>

            <div class="card-grid">
              <div class="price-info">
                <span class="price-label">í˜„ì¬ê°€</span>
                <span class="price-val">$${(pos.lastPrice||pos.entry).toLocaleString(undefined,{maximumFractionDigits:6})}</span>
              </div>

              <div>
                <div class="progress-text">
                  <span style="color:${color}">ìˆ˜ìµë¥  ${pos.pnl.toFixed(2)}%</span>
                  <span>ëª©í‘œê¹Œì§€ ${progress.toFixed(1)}%</span>
                </div>
                <div class="progress-track">
                  <div class="progress-fill" style="width:${progress}%; background:${color};"></div>
                </div>
              </div>

              <div class="price-info">
                <span class="price-label">TP / SL</span>
                <span class="price-val" style="color:var(--success);">$${pos.tp.toLocaleString(undefined,{maximumFractionDigits:6})}</span>
                <div style="height:4px;"></div>
                <span class="price-val" style="color:var(--danger);">$${pos.sl.toLocaleString(undefined,{maximumFractionDigits:6})}</span>
              </div>
            </div>

            <div class="card-foot">${explainLine}</div>
          </div>
        `;
      }).join("");
    }

    function updateStatsUI(){
      document.getElementById("total-stat").innerText = state.history.total;
      const rate = state.history.total > 0 ? (state.history.win / state.history.total) * 100 : 0;
      document.getElementById("win-stat").innerText = `${rate.toFixed(1)}%`;
      document.getElementById("active-stat").innerText = state.activePositions.length;
    }

    // ---------- Auto Scan (ì¶”ì²œ TOP) ----------
    async function autoScanUniverse(){
      const scanBtn = document.getElementById("scan-btn");
      const status = document.getElementById("scan-status");
      scanBtn.disabled = true;
      status.textContent = "ìŠ¤ìº” ì¤‘...";

      try{
        const results = [];
        for(let i=0;i<state.universe.length;i++){
          const coin = state.universe[i];
          status.textContent = `ìŠ¤ìº” ì¤‘... (${i+1}/${state.universe.length})`;

          try{
            const candles = await fetchCandles(coin.s, state.tf, 380);
            if(candles.length < (SIM_WINDOW + FUTURE_H + 80)) continue;
            const pos = buildSignalFromCandles(coin.s, state.tf, candles);
            if(pos.type === "HOLD") continue;

            results.push({
              symbol: pos.symbol,
              tf: pos.tf,
              tfRaw: pos.tfRaw,
              type: pos.type,
              winProb: pos.explain.winProb,
              edge: pos.explain.edge
            });
          }catch(e){
            // ê°œë³„ ì‹¤íŒ¨ëŠ” ë¬´ì‹œ(ì „ì²´ ì•ˆì •ì„±)
          }

          await sleep(SCAN_DELAY_MS);
        }

        results.sort((a,b)=> (b.winProb - a.winProb) || (b.edge - a.edge));
        state.lastScanResults = results.slice(0, 6);
        state.lastScanAt = Date.now();
        saveState();

        renderScanResults();
        status.textContent = state.lastScanResults.length ? "ì™„ë£Œ" : "ì¶”ì²œ ì—†ìŒ";
      }finally{
        scanBtn.disabled = false;
        setTimeout(()=>{ document.getElementById("scan-status").textContent = "ëŒ€ê¸°"; }, 1500);
      }
    }

    function renderScanResults(){
      const container = document.getElementById("rec-container");
      const list = state.lastScanResults || [];
      if(!list.length){
        container.innerHTML = `
          <div style="font-size:11px; color:var(--text-sub); font-weight:900; padding:6px 2px;">
            ì•„ì§ ì¶”ì²œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. â€œìë™ ìŠ¤ìº”â€ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
          </div>
        `;
        return;
      }

      container.innerHTML = list.map(item => {
        const pillClass = item.type === "LONG" ? "long" : "short";
        const prob = (item.winProb*100).toFixed(1);
        const edge = (item.edge*100).toFixed(1);

        return `
          <div class="rec-item" onclick="applyRecommendation('${item.symbol}','${item.tfRaw}')">
            <div class="rec-left">
              ${item.symbol.replace("USDT","")}
              <span class="pill ${pillClass}">${item.type}</span>
            </div>
            <div class="rec-right">
              ì„±ê³µí™•ë¥  ${prob}%<br/>
              ì—£ì§€ ${edge}% Â· ${item.tf}
            </div>
          </div>
        `;
      }).join("");
    }

    function applyRecommendation(symbol, tfRaw){
      // TF ë²„íŠ¼ ë°˜ì˜
      const btns = document.querySelectorAll(".tf-btn");
      btns.forEach(b => b.classList.remove("active"));
      if(tfRaw === "60") btns[0].classList.add("active");
      else if(tfRaw === "240") btns[1].classList.add("active");
      else btns[2].classList.add("active");
      state.tf = tfRaw;

      // ì½”ì¸ ë°˜ì˜
      switchCoin(symbol);
      saveState();
      initChart();
    }

    // ---------- Backtest (ê°„ì´) ----------
    async function runBacktest(){
      const btBtn = document.getElementById("bt-btn");
      btBtn.disabled = true;
      btBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ë°±í…ŒìŠ¤íŠ¸...';

      const box = document.getElementById("bt-box");
      box.classList.remove("show");

      try{
        const candles = await fetchCandles(state.symbol, state.tf, EXTENDED_LIMIT);
        if(candles.length < (SIM_WINDOW + FUTURE_H + 120)) throw new Error("ìº”ë“¤ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");

        // ìŠ¬ë¼ì´ë”©ìœ¼ë¡œ ê³¼ê±°ì—ì„œ ì‹ í˜¸ ìƒì„± â†’ TP/SL ë„ë‹¬ì„ ì´í›„ êµ¬ê°„ì—ì„œ íŒì •
        // (ê°„ì´) ìµœê·¼ BACKTEST_TRADESë²ˆ ì‹œë„
        const closes = candles.map(x=>x.c);
        const highs  = candles.map(x=>x.h);
        const lows   = candles.map(x=>x.l);
        const vols   = candles.map(x=>x.v);

        let wins=0, total=0;
        let pnlSum=0;

        // ë§ˆì§€ë§‰ êµ¬ê°„ ì¼ë¶€ëŠ” ë¯¸ë˜ê°€ ë¶€ì¡±í•˜ë¯€ë¡œ ì œì™¸
        const end = candles.length - (FUTURE_H + 20);
        const start = Math.max(SIM_WINDOW + 80, end - (BACKTEST_TRADES * 6));

        // ì¼ì • ê°„ê²©ìœ¼ë¡œë§Œ ì‹œë„(ê³¼ë„í•œ ê³„ì‚° ë°©ì§€)
        for(let idx = start; idx < end; idx += 6){
          // idxë¥¼ â€œí˜„ì¬ ì‹œì â€ìœ¼ë¡œ ê°€ì •
          const sliceCandles = candles.slice(0, idx+1);
          if(sliceCandles.length < (SIM_WINDOW + FUTURE_H + 80)) continue;

          const pos = buildSignalFromCandles(state.symbol, state.tf, sliceCandles);
          if(pos.type === "HOLD") continue;

          // ì´í›„ êµ¬ê°„ì—ì„œ TP/SL ë¨¼ì € ë‹¿ëŠ”ì§€ íŒì •
          const future = candles.slice(idx+1, Math.min(idx+1+120, candles.length));
          const outcome = simulateOutcome(pos, future);
          if(!outcome.resolved) continue;

          total++;
          if(outcome.win) wins++;
          pnlSum += outcome.pnlPct;

          if(total >= BACKTEST_TRADES) break;
        }

        const winRate = total ? (wins/total)*100 : 0;
        const avgPnl = total ? (pnlSum/total) : 0;

        document.getElementById("bt-n").textContent = `${total}íšŒ`;
        document.getElementById("bt-win").textContent = `${winRate.toFixed(1)}%`;
        document.getElementById("bt-avg").textContent = `${avgPnl.toFixed(2)}%`;

        const tfName = state.tf === "60" ? "1H" : state.tf === "240" ? "4H" : "1D";
        document.getElementById("bt-range").textContent = `${state.symbol} Â· ${tfName} Â· ìµœê·¼ ${EXTENDED_LIMIT}ìº”ë“¤`;

        box.classList.add("show");

      }catch(e){
        console.error(e);
        alert("ë°±í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }finally{
        btBtn.disabled = false;
        btBtn.innerHTML = '<i class="fa-solid fa-flask"></i> ë°±í…ŒìŠ¤íŠ¸';
      }
    }

    function simulateOutcome(pos, futureCandles){
      // futureCandles: [{o,h,l,c,v,t}...]
      // TP/SLì´ ì–´ë–¤ ìº”ë“¤ì—ì„œ ë¨¼ì € ë‹¿ëŠ”ì§€ ê°„ë‹¨íˆ íŒì •(ë³´ìˆ˜ì ìœ¼ë¡œ high/low ì‚¬ìš©)
      for(const c of futureCandles){
        const hi = c.h, lo = c.l;

        if(pos.type === "LONG"){
          if(hi >= pos.tp){
            const pnl = ((pos.tp - pos.entry)/pos.entry)*100;
            return { resolved:true, win:true, pnlPct:pnl };
          }
          if(lo <= pos.sl){
            const pnl = ((pos.sl - pos.entry)/pos.entry)*100;
            return { resolved:true, win:false, pnlPct:pnl };
          }
        }else{
          if(lo <= pos.tp){
            const pnl = ((pos.entry - pos.tp)/pos.entry)*100;
            return { resolved:true, win:true, pnlPct:pnl };
          }
          if(hi >= pos.sl){
            const pnl = ((pos.entry - pos.sl)/pos.entry)*100;
            return { resolved:true, win:false, pnlPct:pnl };
          }
        }
      }
      return { resolved:false, win:false, pnlPct:0 };
    }

    // ---------- Helpers: Candle Fetch ----------
    async function fetchCandles(symbol, tf, limit){
      const res = await fetchJSON(BYBIT_KLINE(symbol, tf, limit), { timeoutMs: 9000, retry: 1 });
      const kline = res?.result?.list || [];
      const candles = kline.map(row => ({
        t: Number(row[0]),
        o: parseFloat(row[1]),
        h: parseFloat(row[2]),
        l: parseFloat(row[3]),
        c: parseFloat(row[4]),
        v: parseFloat(row[5])
      })).filter(x => Number.isFinite(x.t) && Number.isFinite(x.c) && Number.isFinite(x.h) && Number.isFinite(x.l));
      candles.sort((a,b)=> a.t - b.t);
      return candles;
    }

    // ---------- Similarity (z-normalized correlation) ----------
    function calcSimilarityStats(closes, winLen, futureH, step, topK){
      const n = closes.length;
      const curStart = n - winLen;
      const curSeg = closes.slice(curStart, n);
      const curRet = returns(curSeg);

      const sims = [];
      const lastStart = n - winLen - futureH - 2;
      for(let s=0; s<=lastStart; s+=step){
        const seg = closes.slice(s, s + winLen);
        const ret = returns(seg);
        const sim = zncc(curRet, ret);
        if(!Number.isFinite(sim)) continue;

        const entry = closes[s + winLen - 1];
        const future = closes[s + winLen - 1 + futureH];
        const r = (future - entry) / Math.max(entry, 1e-12);
        sims.push({ sim, r });
      }

      sims.sort((a,b)=> b.sim - a.sim);
      const top = sims.slice(0, Math.min(topK, sims.length));

      const count = top.length;
      if(count === 0){
        return { longProb: 0.5, shortProb: 0.5, avgSim: 0, count: 0 };
      }

      const up = top.filter(x => x.r >= 0).length;
      const down = count - up;

      const longProb = (up + 1) / (count + 2);
      const shortProb = (down + 1) / (count + 2);

      const avgZ = top.reduce((a,b)=>a+b.sim,0) / count;
      const avgSim = clamp((avgZ + 1) * 50, 0, 100);

      return { longProb, shortProb, avgSim, count };
    }

    function returns(seg){
      const out = [];
      for(let i=1;i<seg.length;i++){
        out.push((seg[i] - seg[i-1]) / Math.max(seg[i-1], 1e-12));
      }
      return out;
    }

    function zncc(a,b){
      const m = Math.min(a.length, b.length);
      if(m < 5) return 0;

      const a0 = a.slice(0,m);
      const b0 = b.slice(0,m);

      const ma = mean(a0), mb = mean(b0);
      let sa = 0, sb = 0;
      for(let i=0;i<m;i++){
        sa += (a0[i]-ma)*(a0[i]-ma);
        sb += (b0[i]-mb)*(b0[i]-mb);
      }
      sa = Math.sqrt(sa / m);
      sb = Math.sqrt(sb / m);
      if(sa === 0 || sb === 0) return 0;

      let dot = 0;
      for(let i=0;i<m;i++){
        dot += ((a0[i]-ma)/sa) * ((b0[i]-mb)/sb);
      }
      return dot / m;
    }

    function mean(arr){
      return arr.reduce((a,b)=>a+b,0) / Math.max(arr.length,1);
    }

    // ---------- Indicators ----------
    function calcRSI(closes, period=14){
      if(closes.length < period+1) return 50;
      let gains = 0, losses = 0;
      for(let i = closes.length - period - 1; i < closes.length - 1; i++){
        const diff = closes[i+1] - closes[i];
        if(diff >= 0) gains += diff;
        else losses -= diff;
      }
      if(losses === 0) return 100;
      const rs = gains / losses;
      return 100 - (100 / (1 + rs));
    }

    function ema(values, period){
      const k = 2 / (period + 1);
      let prev = values[0];
      const out = [prev];
      for(let i=1;i<values.length;i++){
        prev = values[i]*k + prev*(1-k);
        out.push(prev);
      }
      return out;
    }

    function emaLast(values, period){
      if(values.length < period) return values[values.length-1] || 0;
      const e = ema(values.slice(-Math.max(period*3, period+5)), period);
      return e[e.length-1];
    }

    function calcMACD(closes){
      if(closes.length < 60) return { macd:0, signal:0, hist:0 };
      const e12 = ema(closes, 12);
      const e26 = ema(closes, 26);
      const macdLine = e12.map((v,i)=> v - e26[i]);
      const signalLine = ema(macdLine, 9);
      const macd = macdLine[macdLine.length-1];
      const signal = signalLine[signalLine.length-1];
      const hist = macd - signal;
      return { macd, signal, hist };
    }

    function calcATR(highs, lows, closes, period=14){
      if(closes.length < period+1) return 0;
      const trs = [];
      for(let i=1;i<closes.length;i++){
        const h = highs[i], l = lows[i], pc = closes[i-1];
        const tr = Math.max(h-l, Math.abs(h-pc), Math.abs(l-pc));
        trs.push(tr);
      }
      const slice = trs.slice(-period);
      const sum = slice.reduce((a,b)=>a+b,0);
      return sum / slice.length;
    }

    function calcVolumeTrend(vols, lookback=20){
      if(vols.length < lookback*2) return 0;
      const a = avg(vols.slice(-lookback));
      const b = avg(vols.slice(-(lookback*2), -lookback));
      if(b === 0) return 0;
      return (a - b) / b;
    }

    function avg(arr){
      if(!arr.length) return 0;
      return arr.reduce((a,b)=>a+b,0) / arr.length;
    }

    // ---------- Protections ----------
    function hasActivePosition(symbol, tfRaw){
      return state.activePositions.some(p => p.symbol === symbol && p.tfRaw === tfRaw);
    }

    function isInCooldown(key){
      const last = state.lastSignalAt?.[key] || 0;
      const cd = COOLDOWN_MS[state.tf] || (10*60*1000);
      return (Date.now() - last) < cd;
    }

    // ---------- Storage + Fetch ----------
    function saveState(){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){}
    }
    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : null;
      }catch(e){ return null; }
    }

    async function fetchJSON(url, opt={}){
      const timeoutMs = opt.timeoutMs ?? 7000;
      const retry = opt.retry ?? 0;

      let lastErr = null;
      for(let i=0;i<=retry;i++){
        try{
          const data = await fetchWithTimeout(url, timeoutMs);
          return data;
        }catch(e){
          lastErr = e;
          await sleep(350 * (i+1));
        }
      }
      throw lastErr;
    }

    async function fetchWithTimeout(url, timeoutMs){
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeoutMs);
      try{
        const r = await fetch(url, { cache:"no-store", signal: controller.signal });
        if(!r.ok) throw new Error("HTTP " + r.status);
        return await r.json();
      }finally{
        clearTimeout(id);
      }
    }

    function sleep(ms){ return new Promise(res => setTimeout(res, ms)); }

    // ---------- Utils ----------
    function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }
    function safeLog10(x){ return Math.log10(Math.max(x, 1)); }
    function formatMoney(x){
      if(x >= 1e12) return (x/1e12).toFixed(2)+"T";
      if(x >= 1e9)  return (x/1e9).toFixed(2)+"B";
      if(x >= 1e6)  return (x/1e6).toFixed(2)+"M";
      if(x >= 1e3)  return (x/1e3).toFixed(2)+"K";
      return String(Math.round(x));
    }
  </script>
</body>
</html>
