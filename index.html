<!-- =========================
  YOPO AI PRO (Single-File) v7
  PART 1 / 2 âœ… (UI + ìƒíƒœ/ì¸ì¦ + ì½”ì¸ìœ ë‹ˆë²„ìŠ¤ + ì‹¤ì‹œê°„ê°€ê²© + ì°¨íŠ¸)
  - PART 2ì—ì„œ: "ì˜ˆì¸¡/MTFí•©ì˜/ë³´ìˆ˜í™•ë¥ (ìœŒìŠ¨)/ìœ ì‚¬ë„ì—”ì§„/ìë™ìŠ¤ìº”/ì¶”ì /ì¢…ë£Œê¸°ë¡/ë°±í…ŒìŠ¤íŠ¸"ê¹Œì§€ ì „ë¶€ í™œì„±í™”
  âœ… ì‚¬ìš©ë²•:
   1) ì´ íŒŒì¼ì„ ê·¸ëŒ€ë¡œ ì €ì¥ (ì˜ˆ: yopo_v7_part1.html)
   2) ì‹¤í–‰ í™•ì¸ í›„, ë‚´ê°€ ì£¼ëŠ” PART 2 ì½”ë“œë¥¼ ì´ íŒŒì¼ì˜ ì•ˆë‚´ ìœ„ì¹˜ì— ë¶™ì´ë©´ ì™„ì„±
========================= -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>YOPO AI PRO | Premium Crypto Analytics (v7)</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    :root{
      --primary:#0052ff;
      --primary-dark:#0039b3;
      --primary-light:#e6eeff;
      --secondary:#f8fbff;
      --card-bg:#ffffff;
      --text-main:#1a202c;
      --text-sub:#718096;
      --border:#e2e8f0;
      --success:#00c076;
      --danger:#ff4d4f;
      --shadow:0 4px 20px rgba(0,0,0,.05);
    }
    *{ box-sizing:border-box; }
    body{
      font-family:'Pretendard',-apple-system,BlinkMacSystemFont,system-ui,Roboto,sans-serif;
      background:var(--secondary);
      color:var(--text-main);
      margin:0;
      display:flex;
      height:100vh;
      overflow:hidden;
    }

    /* ---------- AUTH OVERLAY ---------- */
    .auth-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      z-index:999999;
      display:none;
      align-items:center;
      justify-content:center;
      backdrop-filter: blur(7px);
    }
    .auth-card{
      width:420px;
      max-width:92vw;
      background:#fff;
      border:1px solid var(--border);
      border-radius:22px;
      box-shadow:0 30px 60px rgba(0,0,0,.25);
      padding:22px;
    }
    .auth-title{
      font-size:18px;
      font-weight:950;
      color:var(--primary);
      display:flex;
      align-items:center;
      gap:10px;
      margin:0 0 8px 0;
    }
    .auth-sub{
      margin:0 0 14px 0;
      font-size:12px;
      font-weight:850;
      color:var(--text-sub);
      line-height:1.5;
    }
    .auth-row{
      display:flex;
      gap:10px;
      margin-top:12px;
    }
    .auth-input{
      flex:1;
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px 12px;
      font-size:14px;
      font-weight:900;
      outline:none;
      background:#fff;
    }
    .auth-input:focus{ border-color:var(--primary); box-shadow:0 0 0 3px rgba(0,82,255,.12); }
    .auth-btn{
      border:none;
      background:var(--primary);
      color:#fff;
      padding:12px 14px;
      border-radius:12px;
      font-weight:950;
      cursor:pointer;
      white-space:nowrap;
    }
    .auth-btn:hover{ background:var(--primary-dark); }
    .auth-err{
      margin-top:10px;
      font-size:12px;
      font-weight:900;
      color:var(--danger);
      display:none;
    }

    .sidebar{
      width:420px;
      background:var(--card-bg);
      border-right:1px solid var(--border);
      display:flex;
      flex-direction:column;
      z-index:100;
      box-shadow:4px 0 15px rgba(0,0,0,.02);
    }

    .brand-header{
      padding:26px 22px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg,#fff 0%, var(--secondary) 100%);
    }
    .brand-header h1{
      color:var(--primary);
      margin:0;
      font-size:26px;
      font-weight:900;
      letter-spacing:-1px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-badge{
      font-size:10px;
      background:var(--primary);
      color:#fff;
      padding:2px 8px;
      border-radius:4px;
      font-weight:900;
    }
    .brand-sub{
      font-size:12px;
      color:var(--text-sub);
      margin-top:6px;
      font-weight:700;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .mini-pill{
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      background:var(--primary-light);
      color:var(--primary-dark);
      font-weight:900;
      white-space:nowrap;
    }

    .stats-dashboard{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:12px;
      padding:18px 18px 16px;
      background:#fff;
      border-bottom:1px solid var(--border);
    }
    .stat-card{
      background:var(--secondary);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      text-align:center;
      transition:.2s;
    }
    .stat-card:hover{ border-color:var(--primary); transform:translateY(-1px); }
    .stat-label{ font-size:11px; color:var(--text-sub); display:block; margin-bottom:4px; font-weight:900; }
    .stat-value{ font-size:18px; font-weight:950; color:var(--primary); }

    .market-list{ flex:1; overflow-y:auto; padding:12px 14px 12px; }
    .section-title{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:0 6px 10px;
      color:var(--text-sub);
      font-size:12px;
      font-weight:900;
      gap:10px;
    }
    .section-title .right{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:900;
    }
    .status-dot{
      width:8px; height:8px; border-radius:50%;
      background:#cbd5e0;
      display:inline-block;
    }
    .status-dot.ok{ background:var(--success); }
    .status-dot.warn{ background:#f59e0b; }
    .status-dot.bad{ background:var(--danger); }

    .coin-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:16px;
      margin-bottom:10px;
      background:#fff;
      border:1px solid transparent;
      border-radius:14px;
      cursor:pointer;
      transition:.15s ease;
      box-shadow:0 2px 5px rgba(0,0,0,.01);
    }
    .coin-row:hover{ border-color:var(--border); background:var(--secondary); }
    .coin-row.active{
      border-color:var(--primary);
      background:var(--primary-light);
      box-shadow:0 4px 12px rgba(0,82,255,.15);
    }
    .coin-info h4{ margin:0; font-size:16px; font-weight:950; }
    .coin-info span{ font-size:11px; color:var(--text-sub); font-weight:800; }

    .coin-price{ text-align:right; }
    .coin-price .p{
      margin:0;
      font-size:16px;
      font-weight:950;
      color:var(--primary);
      line-height:1.1;
    }
    .coin-price .chg{
      font-size:11px;
      font-weight:900;
      display:block;
      margin-top:5px;
      line-height:1.1;
    }
    .small-metrics{ margin-top:4px; font-size:10px; color:var(--text-sub); font-weight:800; text-align:right; }

    .analysis-controls{
      padding:18px;
      background:#fff;
      border-top:1px solid var(--border);
      box-shadow:0 -5px 20px rgba(0,0,0,.03);
    }
    .tf-selector{
      display:flex;
      background:var(--secondary);
      padding:4px;
      border-radius:10px;
      margin-bottom:12px;
    }
    .tf-btn{
      flex:1;
      border:none;
      background:transparent;
      padding:10px;
      font-size:13px;
      font-weight:950;
      color:var(--text-sub);
      cursor:pointer;
      border-radius:8px;
      transition:.15s;
    }
    .tf-btn.active{
      background:#fff;
      color:var(--primary);
      box-shadow:0 2px 5px rgba(0,0,0,.05);
    }

    .btn-row{
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    .action-btn{
      width:100%;
      border:none;
      background:var(--primary);
      color:#fff;
      padding:14px 12px;
      border-radius:12px;
      font-size:14px;
      font-weight:950;
      cursor:pointer;
      transition:.2s;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      flex:1;
    }
    .action-btn:hover{ background:var(--primary-dark); transform:translateY(-1px); box-shadow:0 5px 15px rgba(0,82,255,.25); }
    .action-btn:disabled{ background:#cbd5e0; cursor:not-allowed; transform:none; box-shadow:none; }

    .action-btn.secondary{
      background:#f1f5f9;
      color:var(--text-main);
      border:1px solid var(--border);
      box-shadow:none;
    }
    .action-btn.secondary:hover{
      background:#e9eef6;
      box-shadow:none;
    }

    .tiny-note{
      margin-top:10px;
      font-size:11px;
      color:var(--text-sub);
      line-height:1.45;
      font-weight:800;
    }

    .recommend-box{
      margin:10px 6px 14px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
    }
    .recommend-title{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:12px;
      font-weight:950;
      color:var(--text-sub);
      margin-bottom:10px;
    }
    .rec-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      margin-bottom:8px;
      cursor:pointer;
      transition:.15s;
      background:var(--secondary);
    }
    .rec-item:hover{ border-color:var(--primary); background:var(--primary-light); }
    .rec-left{ font-weight:950; font-size:13px; }
    .rec-right{ text-align:right; font-size:11px; font-weight:950; color:var(--text-sub); }
    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:10px;
      font-weight:950;
      margin-left:8px;
      border:1px solid var(--border);
      background:#fff;
    }
    .pill.long{ color:var(--success); }
    .pill.short{ color:var(--danger); }
    .pill.hold{ color:var(--text-sub); }

    .history-box{
      margin:0 18px 12px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
    }
    .history-title{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:12px;
      font-weight:950;
      color:var(--text-sub);
      margin-bottom:10px;
    }
    .history-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      margin-bottom:8px;
      background:var(--secondary);
      font-weight:900;
      font-size:12px;
    }
    .history-item .left{
      display:flex; gap:8px; align-items:center;
    }
    .badge-win{
      background:#e6fffa;
      color:var(--success);
      border:1px solid rgba(0,192,118,.25);
      padding:2px 8px;
      border-radius:999px;
      font-size:10px;
      font-weight:950;
    }
    .badge-lose{
      background:#fff5f5;
      color:var(--danger);
      border:1px solid rgba(255,77,79,.25);
      padding:2px 8px;
      border-radius:999px;
      font-size:10px;
      font-weight:950;
    }

    .main-panel{
      flex:1;
      display:flex;
      flex-direction:column;
      position:relative;
      background:#fff;
    }
    .chart-container{
      flex:1.45;
      background:#fff;
      border-bottom:1px solid var(--border);
      position:relative;
    }
    .tracking-dashboard{
      flex:1;
      background:var(--secondary);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      border-top:4px solid var(--primary);
    }
    .tracking-header{
      padding:14px 20px;
      background:#fff;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .tracking-header h3{
      margin:0;
      font-size:16px;
      font-weight:950;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .live-badge{
      font-size:10px;
      background:#ff4d4f;
      color:#fff;
      padding:2px 8px;
      border-radius:999px;
      animation:pulse 1.5s infinite;
      font-weight:950;
    }
    .tracking-list{ flex:1; overflow-y:auto; padding:18px; }

    .modal-overlay{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.4);
      z-index:2000;
      display:none;
      justify-content:center;
      align-items:center;
      backdrop-filter:blur(5px);
    }
    .analysis-modal{
      width:560px;
      max-width:92vw;
      background:#fff;
      border-radius:24px;
      padding:26px;
      box-shadow:0 25px 50px rgba(0,0,0,.2);
      border:1px solid var(--border);
      animation:popUp .25s cubic-bezier(.175,.885,.32,1.275);
    }
    .modal-header{
      text-align:center;
      margin-bottom:18px;
      border-bottom:1px solid var(--border);
      padding-bottom:14px;
    }
    .analysis-text{
      background:var(--secondary);
      padding:16px;
      border-radius:12px;
      font-size:13.5px;
      line-height:1.65;
      color:var(--text-main);
      margin-bottom:14px;
      border-left:4px solid var(--primary);
      font-weight:800;
    }
    .modal-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-bottom:14px;
      font-weight:950;
    }
    .mini-box{
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      text-align:left;
    }
    .mini-box small{ display:block; color:var(--text-sub); font-weight:950; margin-bottom:3px; }
    .modal-btn{
      width:100%;
      padding:14px;
      border:none;
      background:var(--primary);
      color:#fff;
      border-radius:12px;
      font-weight:950;
      cursor:pointer;
      font-size:15px;
    }
    .modal-btn.secondary{
      margin-top:8px;
      background:#f1f5f9;
      color:var(--text-main);
      border:1px solid var(--border);
    }

    @keyframes pulse{0%{opacity:1}50%{opacity:.5}100%{opacity:1}}
    @keyframes popUp{from{transform:scale(.92);opacity:0}to{transform:scale(1);opacity:1}}
  </style>
</head>

<body>
  <!-- AUTH OVERLAY -->
  <div class="auth-overlay" id="auth-overlay">
    <div class="auth-card">
      <h2 class="auth-title"><i class="fa-solid fa-lock"></i> YOPO AI PRO ì ê¸ˆ</h2>
      <p class="auth-sub">
        ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì•¼ ì ‘ì†í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br/>
        (ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸: <b>2580</b>)
      </p>
      <div class="auth-row">
        <input class="auth-input" id="auth-input" type="password" inputmode="numeric" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ (2580)">
        <button class="auth-btn" onclick="tryAuth()">ì…ì¥</button>
      </div>
      <div class="auth-err" id="auth-err">ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.</div>
      <p class="auth-sub" style="margin-top:10px;">
        ì°¸ê³ : ì´ ì ê¸ˆì€ â€œê°€ë²¼ìš´ ì ê¸ˆâ€ì…ë‹ˆë‹¤. (HTMLì„ ì—´ë©´ ë‚´ìš©ì´ ë³´ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤)
      </p>
    </div>
  </div>

  <!-- APP WRAP -->
  <div id="app" style="display:flex; width:100%; height:100%;">
    <div class="sidebar">
      <div class="brand-header">
        <h1><i class="fa-solid fa-layer-group"></i> YOPO AI PRO <span class="brand-badge">PREMIUM</span></h1>
        <div class="brand-sub">
          <span>KMASTER REAL-TIME CRYPTO ANALYTICS</span>
          <span class="mini-pill" id="btc-dom-pill">BTC DOM: --</span>
        </div>
      </div>

      <div class="stats-dashboard">
        <div class="stat-card">
          <span class="stat-label">ëˆ„ì  ë¶„ì„</span>
          <span class="stat-value" id="total-stat">0</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">ì„±ê³µë¥ </span>
          <span class="stat-value" id="win-stat">0%</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">ì¶”ì  ì¤‘</span>
          <span class="stat-value" id="active-stat">0</span>
        </div>
      </div>

      <!-- ìµœê·¼ ì¢…ë£Œ ê¸°ë¡ -->
      <div class="history-box" id="history-box">
        <div class="history-title">
          <span>ìµœê·¼ ì¢…ë£Œ ê¸°ë¡</span>
          <span style="font-weight:950; color:var(--text-sub);" id="history-count">0</span>
        </div>
        <div id="history-container">
          <div style="font-size:11px; color:var(--text-sub); font-weight:900; padding:4px 2px;">
            ì•„ì§ ì¢…ë£Œëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.
          </div>
        </div>
      </div>

      <div class="market-list">
        <div class="section-title">
          <span>ìœ ë§ ì½”ì¸ 15 (ìë™ ì„ ì •)</span>
          <span class="right">
            <span class="status-dot" id="api-dot"></span>
            <span id="universe-ts">ì—…ë°ì´íŠ¸: --</span>
          </span>
        </div>

        <!-- ì¶”ì²œ TOP -->
        <div class="recommend-box">
          <div class="recommend-title">
            <span>ì¶”ì²œ TOP (ìë™ ìŠ¤ìº” ê²°ê³¼)</span>
            <span id="scan-status" style="font-weight:950;">ëŒ€ê¸°</span>
          </div>
          <div id="rec-container">
            <div style="font-size:11px; color:var(--text-sub); font-weight:900; padding:6px 2px;">
              PART 2 ì ìš© í›„ í™œì„±í™”ë©ë‹ˆë‹¤.<br/>
              (ìë™ ìŠ¤ìº” â†’ ì¶”ì²œ í´ë¦­ â†’ ì¦‰ì‹œ ë¶„ì„ â†’ ì¶”ì  ë“±ë¡)
            </div>
          </div>
        </div>

        <div id="market-list-container"></div>
      </div>

      <div class="analysis-controls">
        <div class="tf-selector">
          <button class="tf-btn active" onclick="setTF('60', this)">1H (ë‹¨ê¸°)</button>
          <button class="tf-btn" onclick="setTF('240', this)">4H (ì¤‘ê¸°)</button>
          <button class="tf-btn" onclick="setTF('D', this)">1D (ì¥ê¸°)</button>
        </div>

        <button class="action-btn" id="predict-btn" onclick="executeAnalysis()">
          <i class="fa-solid fa-microchip"></i> AI ë¶„ì„ ë° ì˜ˆì¸¡ ì‹¤í–‰
        </button>

        <div class="btn-row">
          <button class="action-btn secondary" id="scan-btn" onclick="autoScanUniverse()">
            <i class="fa-solid fa-magnifying-glass-chart"></i> ìë™ ìŠ¤ìº”
          </button>
          <button class="action-btn secondary" id="bt-btn" onclick="runBacktest()">
            <i class="fa-solid fa-flask"></i> ë°±í…ŒìŠ¤íŠ¸
          </button>
        </div>

        <div class="tiny-note">
          - ì„œë²„ ì—†ì´(HTML 1íŒŒì¼) ë™ì‘í•˜ëŠ” â€œì•ˆì •í™” ë²„ì „â€ì…ë‹ˆë‹¤.<br/>
          - PART 2ì—ì„œ â€œë©€í‹° íƒ€ì„í”„ë ˆì„ í•©ì˜ + ë³´ìˆ˜í™•ë¥ (ìœŒìŠ¨) + HOLD ê°•í™” + ì¶”ì /ë°±í…ŒìŠ¤íŠ¸â€ê°€ ë“¤ì–´ê°‘ë‹ˆë‹¤.
        </div>
      </div>
    </div>

    <div class="main-panel">
      <div class="chart-container" id="chart-wrap"></div>

      <div class="tracking-dashboard">
        <div class="tracking-header">
          <h3><i class="fa-solid fa-radar"></i> ì‹¤ì‹œê°„ í¬ì§€ì…˜ ì •ë°€ ì¶”ì </h3>
          <span class="live-badge">LIVE</span>
        </div>
        <div class="tracking-list" id="tracking-container">
          <div style="text-align:center; padding:50px; color:var(--text-sub); font-weight:950;">
            PART 2 ì ìš© í›„ ì¶”ì  ì¹´ë“œê°€ í™œì„±í™”ë©ë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="result-modal">
      <div class="analysis-modal">
        <div class="modal-header">
          <div id="modal-icon" style="font-size:40px; margin-bottom:8px;">ğŸ§ </div>
          <h2 id="modal-title" style="margin:0; color:var(--primary);">ë¶„ì„ ê²°ê³¼</h2>
          <p id="modal-subtitle" style="margin:6px 0 0; color:var(--text-sub); font-weight:900;">--</p>
        </div>

        <div class="modal-grid" id="modal-grid"></div>
        <div id="modal-content" class="analysis-text">PART 2 ì ìš© í›„ ê²°ê³¼ ì„¤ëª…ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>

        <button class="modal-btn" id="modal-confirm" onclick="confirmTrack()">ì¶”ì  ì‹œìŠ¤í…œì— ë“±ë¡</button>
        <button class="modal-btn secondary" onclick="closeModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <script src="https://s3.tradingview.com/tv.js"></script>
  <script>
    /*************************************************************
     * YOPO AI PRO (Single-File, v7)
     * PART 1: UI/ìƒíƒœ/ì¸ì¦/ìœ ë‹ˆë²„ìŠ¤/ì‹¤ì‹œê°„ê°€ê²©/ì°¨íŠ¸
     *************************************************************/

    // ---------- AUTH ----------
    const AUTH_PASSWORD = "2580";
    const AUTH_KEY = "yopo_auth_ok_v1";

    function isAuthed(){
      try{ return localStorage.getItem(AUTH_KEY) === "1"; }catch(e){ return false; }
    }
    function showAuth(){
      document.getElementById("auth-overlay").style.display = "flex";
      document.getElementById("app").style.display = "none";
      setTimeout(()=>{ document.getElementById("auth-input")?.focus(); }, 50);
    }
    function hideAuth(){
      document.getElementById("auth-overlay").style.display = "none";
      document.getElementById("app").style.display = "flex";
    }
    function tryAuth(){
      const input = document.getElementById("auth-input");
      const err = document.getElementById("auth-err");
      if(!input) return;
      const v = String(input.value || "").trim();
      if(v === AUTH_PASSWORD){
        try{ localStorage.setItem(AUTH_KEY, "1"); }catch(e){}
        err.style.display = "none";
        hideAuth();
      }else{
        err.style.display = "block";
        input.value = "";
        input.focus();
      }
    }

    // ---------- Storage ----------
    const STORAGE_KEY = "yopo_single_v7_state";

    // ---------- API ----------
    const BYBIT_TICKERS = "https://api.bybit.com/v5/market/tickers?category=linear";
    const CG_MARKETS = "https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=200&page=1&sparkline=false&price_change_percentage=24h";
    const CG_GLOBAL  = "https://api.coingecko.com/api/v3/global";

    // ---------- Candidate List (15) ----------
    const DEFAULT_CANDIDATES = [
      { s: "BTCUSDT", n: "ë¹„íŠ¸ì½”ì¸", cg: "bitcoin" },
      { s: "ETHUSDT", n: "ì´ë”ë¦¬ì›€", cg: "ethereum" },
      { s: "SOLUSDT", n: "ì†”ë¼ë‚˜", cg: "solana" },
      { s: "XRPUSDT", n: "ë¦¬í”Œ", cg: "ripple" },
      { s: "ADAUSDT", n: "ì—ì´ë‹¤", cg: "cardano" },
      { s: "DOGEUSDT", n: "ë„ì§€ì½”ì¸", cg: "dogecoin" },
      { s: "AVAXUSDT", n: "ì•„ë°œë€ì²´", cg: "avalanche-2" },
      { s: "DOTUSDT", n: "í´ì¹´ë‹·", cg: "polkadot" },
      { s: "LINKUSDT", n: "ì²´ì¸ë§í¬", cg: "chainlink" },
      { s: "POLUSDT", n: "í´ë¦¬ê³¤", cg: "polygon-ecosystem-token" },
      { s: "TRXUSDT", n: "íŠ¸ë¡ ", cg: "tron" },
      { s: "BCHUSDT", n: "ë¹„íŠ¸ì½”ì¸ìºì‹œ", cg: "bitcoin-cash" },
      { s: "NEARUSDT", n: "ë‹ˆì–´í”„ë¡œí† ì½œ", cg: "near" },
      { s: "LTCUSDT", n: "ë¼ì´íŠ¸ì½”ì¸", cg: "litecoin" },
      { s: "APTUSDT", n: "ì•±í† ìŠ¤", cg: "aptos" }
    ];

    // ---------- State ----------
    let state = loadState() || {
      symbol: "BTCUSDT",
      tf: "60",
      universe: DEFAULT_CANDIDATES.map(x => ({...x})),
      activePositions: [],            // PART 2ì—ì„œ ì‚¬ìš©
      history: { total: 0, win: 0 },  // PART 2ì—ì„œ ì‚¬ìš©
      closedTrades: [],               // PART 2ì—ì„œ ì‚¬ìš©
      lastUniverseAt: 0,
      btcDom: null,
      btcDomPrev: null,
      lastApiHealth: "warn",
      lastSignalAt: {},               // PART 2ì—ì„œ ì‚¬ìš©
      lastScanAt: 0,                  // PART 2ì—ì„œ ì‚¬ìš©
      lastScanResults: [],            // PART 2ì—ì„œ ì‚¬ìš©
      lastPrices: {}                  // {symbol:{price,chg,ts}}
    };

    // ---------- Boot ----------
    document.addEventListener("DOMContentLoaded", async () => {
      // auth gate
      if(!isAuthed()){
        showAuth();
      }else{
        hideAuth();
      }
      document.getElementById("auth-input")?.addEventListener("keydown", (e)=>{
        if(e.key === "Enter") tryAuth();
      });

      initChart();
      renderUniverseList();
      updateStatsUI();

      await refreshUniverseAndGlobals();
      await marketTick();

      setInterval(marketTick, 2000);
      setInterval(refreshUniverseAndGlobals, 60000);
    });

    // ---------- UI ----------
    function setTF(tf, btn){
      state.tf = tf;
      document.querySelectorAll(".tf-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      saveState();
      initChart();
    }

    function switchCoin(symbol){
      state.symbol = symbol;
      document.querySelectorAll(".coin-row").forEach(r => r.classList.remove("active"));
      const row = document.getElementById(`row-${symbol}`);
      if(row) row.classList.add("active");
      saveState();
      initChart();
    }

    // ---------- Chart ----------
    function initChart(){
      const wrap = document.getElementById("chart-wrap");
      if(!wrap) return;

      wrap.innerHTML = "";
      try{
        new TradingView.widget({
          autosize:true,
          symbol:"BYBIT:" + state.symbol,
          interval:state.tf,
          timezone:"Asia/Seoul",
          theme:"light",
          style:"1",
          locale:"ko",
          toolbar_bg:"#f1f3f6",
          enable_publishing:false,
          hide_top_toolbar:false,
          container_id:"chart-wrap"
        });
      }catch(e){
        wrap.innerHTML = `
          <div style="padding:20px; color:var(--text-sub); font-weight:900;">
            ì°¨íŠ¸ ë¡œë”© ì‹¤íŒ¨(ë„¤íŠ¸ì›Œí¬/ì°¨ë‹¨ ê°€ëŠ¥). ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.
          </div>
        `;
      }
    }

    // ---------- Universe + Dominance ----------
    async function refreshUniverseAndGlobals(){
      const apiDot = document.getElementById("api-dot");

      try{
        const g = await fetchJSON(CG_GLOBAL, { timeoutMs: 6000, retry: 1 });
        const dom = g?.data?.market_cap_percentage?.btc;

        if(typeof dom === "number"){
          state.btcDomPrev = (typeof state.btcDom === "number") ? state.btcDom : null;
          state.btcDom = dom;
          document.getElementById("btc-dom-pill").innerText = `BTC DOM: ${dom.toFixed(1)}%`;
        }

        const markets = await fetchJSON(CG_MARKETS, { timeoutMs: 7000, retry: 1 });

        const enriched = DEFAULT_CANDIDATES.map(c => {
          const m = Array.isArray(markets) ? markets.find(x => x.id === c.cg) : null;
          const mc = m?.market_cap ?? 0;
          const vol = m?.total_volume ?? 0;
          const chg = m?.price_change_percentage_24h ?? 0;

          const score =
            safeLog10(mc) * 0.45 +
            safeLog10(vol) * 0.45 +
            Math.min(Math.abs(chg), 20) * 0.10;

          return { ...c, mc, vol, chg, score };
        }).sort((a,b)=> b.score - a.score);

        state.universe = enriched.slice(0, 15);
        state.lastUniverseAt = Date.now();
        state.lastApiHealth = "ok";
        saveState();

        document.getElementById("universe-ts").innerText =
          `ì—…ë°ì´íŠ¸: ${new Date(state.lastUniverseAt).toLocaleTimeString()}`;

        apiDot.className = "status-dot ok";
        renderUniverseList();
      }catch(e){
        console.warn("CoinGecko unavailable -> fallback to Bybit universe", e);
        apiDot.className = "status-dot warn";
        state.lastApiHealth = "warn";
        saveState();
        await fallbackUniverseFromBybit();
      }
    }

    async function fallbackUniverseFromBybit(){
      try{
        const json = await fetchJSON(BYBIT_TICKERS, { timeoutMs: 7000, retry: 1 });
        const tickers = json?.result?.list || [];

        const rows = tickers
          .map(t => {
            const symbol = t.symbol;
            const last = parseFloat(t.lastPrice || "0");
            const chg = parseFloat(t.price24hPcnt || "0") * 100;
            const turn =
              parseFloat(t.turnover24h || "0") ||
              parseFloat(t.turnover || "0") ||
              parseFloat(t.volume24h || "0") ||
              parseFloat(t.volume || "0") || 0;
            return { symbol, last, chg, turn };
          })
          .filter(x => x.symbol && x.symbol.endsWith("USDT") && x.last > 0);

        rows.sort((a,b)=> (b.turn - a.turn));
        const top = rows.slice(0, 60);

        const baseSet = new Set(DEFAULT_CANDIDATES.map(x=>x.s));
        const picked = [];

        for(const r of top){
          if(picked.length >= 15) break;
          if(baseSet.has(r.symbol)){
            const base = DEFAULT_CANDIDATES.find(x=>x.s===r.symbol);
            picked.push({ ...base, chg: r.chg, turn: r.turn, score: safeLog10(r.turn) });
          }
        }
        for(const r of top){
          if(picked.length >= 15) break;
          if(picked.some(x=>x.s===r.symbol)) continue;
          picked.push({ s: r.symbol, n: r.symbol.replace("USDT",""), cg: null, chg: r.chg, turn: r.turn, score: safeLog10(r.turn) });
        }

        state.universe = picked.slice(0, 15);
        state.lastUniverseAt = Date.now();
        saveState();

        document.getElementById("universe-ts").innerText =
          `ì—…ë°ì´íŠ¸: ${new Date(state.lastUniverseAt).toLocaleTimeString()}`;

        renderUniverseList();
      }catch(e){
        console.error("Bybit fallback universe failed:", e);
      }
    }

    function renderUniverseList(){
      const container = document.getElementById("market-list-container");
      if(!container) return;

      container.innerHTML = "";
      state.universe.forEach(coin => {
        const div = document.createElement("div");
        div.className = `coin-row ${coin.s === state.symbol ? "active" : ""}`;
        div.id = `row-${coin.s}`;
        div.onclick = () => switchCoin(coin.s);

        div.innerHTML = `
          <div class="coin-info">
            <h4>${coin.s.replace("USDT","")}</h4>
            <span>${coin.n || "-"}</span>
          </div>
          <div class="coin-price">
            <div class="p" id="p-${coin.s}">---</div>
            <div class="chg" id="c-${coin.s}">---</div>
            <div class="small-metrics" id="meta-${coin.s}"></div>
          </div>
        `;
        container.appendChild(div);

        const meta = document.getElementById(\`meta-\${coin.s}\`);
        if(meta){
          const mcTxt = coin.mc ? `ì‹œì´ ${formatMoney(coin.mc)}` : "";
          const volTxt = coin.vol ? `ê±°ë˜ëŸ‰ ${formatMoney(coin.vol)}` : "";
          const turnTxt = coin.turn ? `ìœ ë™ì„± ${formatMoney(coin.turn)}` : "";
          const chgTxt = (typeof coin.chg === "number") ? `24h ${coin.chg.toFixed(1)}%` : "";
          meta.innerText = [mcTxt, volTxt, turnTxt, chgTxt].filter(Boolean).join(" Â· ");
        }

        // ìºì‹œëœ ê°€ê²©ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ í‘œì‹œ
        const cached = state.lastPrices?.[coin.s];
        if(cached?.price){
          updateCoinRow(coin.s, cached.price, cached.chg ?? 0, true);
        }
      });
    }

    // ---------- Market tick ----------
    async function marketTick(){
      try{
        const json = await fetchJSON(BYBIT_TICKERS, { timeoutMs: 7000, retry: 1 });
        const tickers = json?.result?.list || [];
        const symbols = new Set(state.universe.map(x => x.s));

        for(const t of tickers){
          if(!symbols.has(t.symbol)) continue;

          const price = parseFloat(t.lastPrice || "0");
          const chg = parseFloat(t.price24hPcnt || "0") * 100;

          if(price > 0){
            updateCoinRow(t.symbol, price, chg);
            state.lastPrices[t.symbol] = { price, chg, ts: Date.now() };
          }
        }

        saveState();

        if(!symbols.has(state.symbol) && state.universe[0]){
          switchCoin(state.universe[0].s);
        }
      }catch(e){
        console.error("Market tick error:", e);
        const dot = document.getElementById("api-dot");
        if(dot) dot.className = "status-dot bad";
      }
    }

    function updateCoinRow(symbol, price, changePct, silent=false){
      const pEl = document.getElementById(`p-${symbol}`);
      const cEl = document.getElementById(`c-${symbol}`);
      if(!pEl || !cEl) return;

      const color = changePct >= 0 ? "var(--success)" : "var(--danger)";
      const sign = changePct >= 0 ? "+" : "";

      pEl.style.color = "var(--primary)";
      pEl.textContent = `$${price.toLocaleString(undefined,{maximumFractionDigits:6})}`;

      cEl.style.color = color;
      cEl.textContent = `${sign}${changePct.toFixed(2)}%`;

      // PART 1ì—ì„œëŠ” UI ê°±ì‹ ë§Œ ìˆ˜í–‰
      if(!silent){
        // (PART 2ì—ì„œ ì—¬ê¸°ì„œ ì¶”ì  ì—…ë°ì´íŠ¸ë¡œ ì—°ê²°ë©ë‹ˆë‹¤)
      }
    }

    // ---------- Stats ----------
    function updateStatsUI(){
      const totalEl = document.getElementById("total-stat");
      const winEl = document.getElementById("win-stat");
      const activeEl = document.getElementById("active-stat");
      if(!totalEl || !winEl || !activeEl) return;

      totalEl.innerText = state.history.total || 0;
      const total = state.history.total || 0;
      const win = state.history.win || 0;
      const rate = total > 0 ? (win / total) * 100 : 0;
      winEl.innerText = `${rate.toFixed(1)}%`;
      activeEl.innerText = (state.activePositions || []).length;
    }

    // ---------- Modal (PART 1 stub) ----------
    function closeModal(){
      const m = document.getElementById("result-modal");
      if(m) m.style.display = "none";
    }
    function confirmTrack(){
      alert("PART 2ë¥¼ ë¶™ì´ë©´ 'ì¶”ì  ë“±ë¡/ì¢…ë£Œ/í†µê³„'ê°€ ì™„ì„±ë©ë‹ˆë‹¤.");
    }

    // ---------- Buttons (PART 1 stub) ----------
    function executeAnalysis(){
      alert("PART 2ë¥¼ ë¶™ì´ë©´ 'AI ë¶„ì„/ì˜ˆì¸¡'ì´ í™œì„±í™”ë©ë‹ˆë‹¤.");
    }
    function autoScanUniverse(){
      alert("PART 2ë¥¼ ë¶™ì´ë©´ 'ìë™ ìŠ¤ìº”'ì´ í™œì„±í™”ë©ë‹ˆë‹¤.");
    }
    function runBacktest(){
      alert("PART 2ë¥¼ ë¶™ì´ë©´ 'ë°±í…ŒìŠ¤íŠ¸'ê°€ í™œì„±í™”ë©ë‹ˆë‹¤.");
    }
    function quickAnalyzeAndShow(){
      alert("PART 2ë¥¼ ë¶™ì´ë©´ 'ì¶”ì²œ í´ë¦­ ì¦‰ì‹œ ë¶„ì„'ì´ í™œì„±í™”ë©ë‹ˆë‹¤.");
    }

    // ---------- Storage + Fetch ----------
    function saveState(){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){}
    }
    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : null;
      }catch(e){ return null; }
    }

    async function fetchJSON(url, opt={}){
      const timeoutMs = opt.timeoutMs ?? 7000;
      const retry = opt.retry ?? 0;

      let lastErr = null;
      for(let i=0;i<=retry;i++){
        try{
          const data = await fetchWithTimeout(url, timeoutMs);
          return data;
        }catch(e){
          lastErr = e;
          await sleep(350 * (i+1));
        }
      }
      throw lastErr;
    }

    async function fetchWithTimeout(url, timeoutMs){
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeoutMs);
      try{
        const r = await fetch(url, { cache:"no-store", signal: controller.signal });
        if(!r.ok) throw new Error("HTTP " + r.status);
        return await r.json();
      }finally{
        clearTimeout(id);
      }
    }

    function sleep(ms){ return new Promise(res => setTimeout(res, ms)); }

    // ---------- Utils ----------
    function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }
    function safeLog10(x){ return Math.log10(Math.max(x, 1)); }
    function formatMoney(x){
      if(x >= 1e12) return (x/1e12).toFixed(2)+"T";
      if(x >= 1e9)  return (x/1e9).toFixed(2)+"B";
      if(x >= 1e6)  return (x/1e6).toFixed(2)+"M";
      if(x >= 1e3)  return (x/1e3).toFixed(2)+"K";
      return String(Math.round(x));
    }
  </script>

  <!-- ======================================================
       âœ… PART 2 ë¶™ì´ëŠ” ìœ„ì¹˜ (ì—¬ê¸°ì— ë‚´ê°€ ì£¼ëŠ” PART 2 ì „ì²´ <script>ë¥¼ ë¶™ì´ë©´ ë)
       ====================================================== -->
  <!-- =========================
  YOPO AI PRO (Single-File) v7
  PART 2 / 2 âœ… (ì˜ˆì¸¡/MTFí•©ì˜/ë³´ìˆ˜í™•ë¥ /ìœ ì‚¬ë„ì—”ì§„/ìë™ìŠ¤ìº”/ì¶”ì /ì¢…ë£Œê¸°ë¡/ë°±í…ŒìŠ¤íŠ¸)
  âœ… ë¶™ì´ëŠ” ê³³:
   - PART 1 íŒŒì¼ ë§¨ ì•„ë˜:
     "<!-- PART 2 ë¶™ì´ëŠ” ìœ„ì¹˜ -->" ë°”ë¡œ ì•„ë˜ì— í†µì§¸ë¡œ ë¶™ì—¬ë„£ê¸°
========================= -->

<script>
/*************************************************************
 * YOPO AI PRO (Single-File, v7)
 * PART 2: Prediction Engine + MTF + Scan + Tracking + History + Backtest
 *
 * âœ… ì´ PART 2ëŠ” PART 1ì˜ stub í•¨ìˆ˜ë“¤ì„ "ë®ì–´ì“°ê¸°" í•©ë‹ˆë‹¤.
 * âœ… ì™¸ë¶€ ì„œë²„ ì—†ì´ ì‘ë™(ë¸Œë¼ìš°ì € fetch + localStorage)
 *************************************************************/

/* ----------------------------------------------------------
   0) íŒŒë¼ë¯¸í„° (ìŠ¹ë¥ ì„ ì˜¬ë¦¬ê¸° ìœ„í•´ "ë³´ìˆ˜ì ìœ¼ë¡œ" ì„¸íŒ…)
---------------------------------------------------------- */
// Similarity / Analysis Params
const SIM_WINDOW = 44;     // í˜„ì¬íŒ¨í„´ ê¸¸ì´
const FUTURE_H   = 8;      // ë¯¸ë˜í‰ê°€ êµ¬ê°„
const SIM_STEP   = 2;
const SIM_TOPK   = 28;

// HOLD rules (ë³´ë¥˜ ê°•í™”)
const HOLD_MIN_TOPK     = 14;
const HOLD_MIN_SIM_AVG  = 58;     // ìœ ì‚¬ë„ í‰ê· 
const HOLD_MIN_EDGE     = 0.10;   // ë¡±/ìˆ ì°¨ì´(ì—£ì§€)
const HOLD_MIN_TP_PCT   = 0.90;   // ëª©í‘œìˆ˜ìµ ìµœì†Œ 0.9%

// TP/SL
const RR = 2.0;
const TF_MULT = { "60": 1.15, "240": 1.9, "D": 3.3 };
const ATR_MIN_PCT = 0.15;
const TP_MAX_PCT  = 20.0;

// cooldown
const COOLDOWN_MS = { "60": 10 * 60 * 1000, "240": 30 * 60 * 1000, "D": 2 * 60 * 60 * 1000 };

// scan delay
const SCAN_DELAY_MS = 650;

// fetch limit
const EXTENDED_LIMIT = 900;

/* ----------------------------------------------------------
   1) ë©€í‹° íƒ€ì„í”„ë ˆì„(MTF) í•©ì˜ ì„¤ì •
---------------------------------------------------------- */
const MTF_ENABLED = true;
const MTF_SET = {
  "60":  ["60","240","D"],
  "240": ["240","D","60"],
  "D":   ["D","240","60"]
};
const MTF_WEIGHT = {
  "60":  { "60": 0.50, "240": 0.32, "D": 0.18 },
  "240": { "240": 0.50, "D": 0.32, "60": 0.18 },
  "D":   { "D": 0.52, "240": 0.33, "60": 0.15 }
};
const MTF_MIN_ALIGN_SCORE = 0.64;
const MTF_MIN_EDGE        = 0.09;
const MTF_DISAGREE_HOLD   = true;

/* ----------------------------------------------------------
   2) ë³´ìˆ˜ í™•ë¥ (ìœŒìŠ¨ í•˜í•œ) ì„¤ì •
---------------------------------------------------------- */
const WILSON_Z = 1.64; // ì•½ 90% ì‹ ë¢° í•˜í•œ
const MIN_WINPROB_TO_TRADE = 0.585;

/* ----------------------------------------------------------
   3) BTC ë„ë¯¸ë„ŒìŠ¤/ì•ŒíŠ¸ í™˜ê²½ ë³´ìˆ˜í™”
---------------------------------------------------------- */
const DOM_DAMP_BASE = 0.90;
const DOM_ALT_PENALTY = 0.86;
const DOM_UP_PENALTY  = 0.88;

/* ----------------------------------------------------------
   4) Auto Scan (ì¶”ì²œ)
---------------------------------------------------------- */
const REC_MAX = 6;

/* ----------------------------------------------------------
   5) Backtest ì„¤ì •
---------------------------------------------------------- */
const BACKTEST_TRADES = 80;
const BT_MIN_PROB  = 0.60;
const BT_MIN_EDGE  = 0.11;
const BT_MIN_SIM   = 60;
const BT_MIN_ALIGN = 0.66;

/* ==========================================================
   A) PART 1 API ì¶”ê°€
========================================================== */
const BYBIT_KLINE = (symbol, interval, limit) =>
  `https://api.bybit.com/v5/market/kline?category=linear&symbol=${encodeURIComponent(symbol)}&interval=${encodeURIComponent(interval)}&limit=${limit}`;

/* ==========================================================
   B) ë¶„ì„ ì‹¤í–‰(ë©”ì¸ ë²„íŠ¼) - ì‹¤ì œ êµ¬í˜„
========================================================== */
async function executeAnalysis(){
  const btn = document.getElementById("predict-btn");
  btn.disabled = true;
  btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ë¶„ì„ ì¤‘...';

  try{
    const dupKey = `${state.symbol}|${state.tf}`;

    if(hasActivePosition(state.symbol, state.tf)){
      alert("ì´ë¯¸ ê°™ì€ ì½”ì¸/ê°™ì€ ê¸°ê°„ì˜ ì¶”ì  í¬ì§€ì…˜ì´ ìˆìŠµë‹ˆë‹¤. (ì¤‘ë³µ ë°©ì§€)");
      return;
    }
    if(isInCooldown(dupKey)){
      alert("ë„ˆë¬´ ìì£¼ ì‹ í˜¸ë¥¼ ë‚´ë©´ ìŠ¹ë¥ ì´ ë‚´ë ¤ê°ˆ ìˆ˜ ìˆì–´ìš”. ì§€ê¸ˆì€ ì¿¨ë‹¤ìš´ì…ë‹ˆë‹¤.");
      return;
    }

    const pos = await buildFinalSignalMTF(state.symbol, state.tf);
    state.lastSignalAt[dupKey] = Date.now();
    saveState();

    showResultModal(pos);
  }catch(e){
    console.error(e);
    alert("ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (API ì§€ì—°/ì œí•œ ê°€ëŠ¥)");
  }finally{
    btn.disabled = false;
    btn.innerHTML = '<i class="fa-solid fa-microchip"></i> AI ë¶„ì„ ë° ì˜ˆì¸¡ ì‹¤í–‰';
  }
}

/* ==========================================================
   C) ì¶”ì²œ í´ë¦­ ì¦‰ì‹œ ë¶„ì„
========================================================== */
async function quickAnalyzeAndShow(symbol, tfRaw){
  try{
    // TF ë²„íŠ¼ UI ë™ê¸°í™”
    const btns = document.querySelectorAll(".tf-btn");
    btns.forEach(b => b.classList.remove("active"));
    if(tfRaw === "60") btns[0].classList.add("active");
    else if(tfRaw === "240") btns[1].classList.add("active");
    else btns[2].classList.add("active");
    state.tf = tfRaw;

    // ì½”ì¸ ì ìš©
    switchCoin(symbol);
    saveState();
    initChart();

    if(hasActivePosition(symbol, tfRaw)){
      alert("ì´ë¯¸ ê°™ì€ ì½”ì¸/ê°™ì€ ê¸°ê°„ì˜ ì¶”ì  í¬ì§€ì…˜ì´ ìˆìŠµë‹ˆë‹¤. (ì¤‘ë³µ ë°©ì§€)");
      return;
    }

    const pos = await buildFinalSignalMTF(symbol, tfRaw);
    showResultModal(pos);
  }catch(e){
    console.error(e);
    alert("ì¶”ì²œ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}

/* ==========================================================
   D) ìë™ ìŠ¤ìº”(ì¶”ì²œ TOP) - ì‹¤ì œ êµ¬í˜„
========================================================== */
async function autoScanUniverse(){
  const scanBtn = document.getElementById("scan-btn");
  const status = document.getElementById("scan-status");
  scanBtn.disabled = true;
  status.textContent = "ìŠ¤ìº” ì¤‘...";

  try{
    const results = [];
    for(let i=0;i<state.universe.length;i++){
      const coin = state.universe[i];
      status.textContent = `ìŠ¤ìº” ì¤‘... (${i+1}/${state.universe.length})`;

      try{
        const pos = await buildFinalSignalMTF(coin.s, state.tf, { scanMode:true });
        if(pos.type === "HOLD") { await sleep(SCAN_DELAY_MS); continue; }

        results.push({
          symbol: pos.symbol,
          tf: pos.tf,
          tfRaw: pos.tfRaw,
          type: pos.type,
          winProb: pos.explain?.winProbConservative ?? pos.explain?.winProb ?? 0,
          edge: pos.explain?.edge ?? 0,
          mtfAlign: pos.explain?.mtf?.alignScore ?? 0
        });
      }catch(e){}

      await sleep(SCAN_DELAY_MS);
    }

    results.sort((a,b)=>
      (b.winProb - a.winProb) ||
      (b.edge - a.edge) ||
      (b.mtfAlign - a.mtfAlign)
    );

    state.lastScanResults = results.slice(0, REC_MAX);
    state.lastScanAt = Date.now();
    saveState();

    renderScanResults();
    status.textContent = state.lastScanResults.length ? "ì™„ë£Œ" : "ì¶”ì²œ ì—†ìŒ";
  }finally{
    scanBtn.disabled = false;
    setTimeout(()=>{ document.getElementById("scan-status").textContent = "ëŒ€ê¸°"; }, 1500);
  }
}

/* ==========================================================
   E) ì¶”ì²œ UI ë Œë”
========================================================== */
function renderScanResults(){
  const container = document.getElementById("rec-container");
  const list = state.lastScanResults || [];
  if(!list.length){
    container.innerHTML = `
      <div style="font-size:11px; color:var(--text-sub); font-weight:900; padding:6px 2px;">
        ì•„ì§ ì¶”ì²œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. â€œìë™ ìŠ¤ìº”â€ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
      </div>
    `;
    return;
  }

  container.innerHTML = list.map(item => {
    const pillClass = item.type === "LONG" ? "long" : "short";
    const prob = (item.winProb*100).toFixed(1);
    const edge = (item.edge*100).toFixed(1);
    const align = (item.mtfAlign*100).toFixed(0);

    return `
      <div class="rec-item" onclick="quickAnalyzeAndShow('${item.symbol}','${item.tfRaw}')">
        <div class="rec-left">
          ${item.symbol.replace("USDT","")}
          <span class="pill ${pillClass}">${item.type}</span>
        </div>
        <div class="rec-right">
          ë³´ìˆ˜í™•ë¥  ${prob}%<br/>
          ì—£ì§€ ${edge}% Â· í•©ì˜ ${align}% Â· ${item.tf}
        </div>
      </div>
    `;
  }).join("");
}

/* ==========================================================
   F) MTF ìµœì¢… ì‹œê·¸ë„ ìƒì„±(í•µì‹¬)
========================================================== */
async function buildFinalSignalMTF(symbol, tfRaw, opt={}){
  const tfSet = MTF_SET[tfRaw] || [tfRaw];
  const weights = MTF_WEIGHT[tfRaw] || { [tfRaw]:1.0 };

  const perTF = [];
  for(const tf of tfSet){
    const candles = await fetchCandles(symbol, tf, EXTENDED_LIMIT);
    if(candles.length < (SIM_WINDOW + FUTURE_H + 80)){
      perTF.push({ tf, ok:false, reason:"ìº”ë“¤ ë¶€ì¡±" });
      continue;
    }
    const s = buildSignalFromCandlesOneTF(symbol, tf, candles);
    perTF.push({ tf, ok:true, sig:s });
  }

  const valid = perTF.filter(x=>x.ok).map(x=>x.sig);
  if(valid.length === 0){
    throw new Error("ë¶„ì„ ê°€ëŠ¥í•œ íƒ€ì„í”„ë ˆì„ì´ ì—†ìŠµë‹ˆë‹¤.");
  }

  if(!MTF_ENABLED || valid.length === 1){
    const single = valid[0];
    return finalizeSingleToDisplay(single);
  }

  let longScore = 0;
  let shortScore = 0;
  let holdHits = 0;

  for(const item of perTF){
    if(!item.ok) continue;
    const w = weights[item.tf] ?? 0.2;
    const sig = item.sig;

    if(sig.type === "HOLD"){
      holdHits += w;
      continue;
    }
    if(sig.type === "LONG") longScore += w;
    else if(sig.type === "SHORT") shortScore += w;
  }

  const totalScore = longScore + shortScore + holdHits + 1e-9;
  const alignLong = longScore / totalScore;
  const alignShort = shortScore / totalScore;
  const alignHold = holdHits / totalScore;

  const picked = (alignLong >= alignShort) ? "LONG" : "SHORT";
  const alignScore = Math.max(alignLong, alignShort);
  const mtfEdge = Math.abs(alignLong - alignShort);

  const mtfHoldReasons = [];
  if(alignHold >= 0.34) mtfHoldReasons.push(`ì—¬ëŸ¬ TFê°€ ë³´ë¥˜(í•©ì˜ ì–´ë ¤ì›€)`);
  if(alignScore < MTF_MIN_ALIGN_SCORE) mtfHoldReasons.push(`íƒ€ì„í”„ë ˆì„ í•©ì˜ ë¶€ì¡±(${(alignScore*100).toFixed(0)}%)`);
  if(mtfEdge < MTF_MIN_EDGE) mtfHoldReasons.push(`í•©ì˜ ì—£ì§€ ë¶€ì¡±(${(mtfEdge*100).toFixed(1)}%)`);

  const base = valid.find(x=>x.tfRaw===tfRaw) || valid[0];

  let finalType = base.type;
  if(finalType !== "HOLD"){
    const oppositeStrong = (picked !== finalType) && (alignScore >= 0.72);
    if(MTF_DISAGREE_HOLD && oppositeStrong){
      finalType = "HOLD";
      mtfHoldReasons.push(`MTFê°€ ê°•í•˜ê²Œ ë°˜ëŒ€(ìŠ¹ë¥  ë³´í˜¸)`);
    }
  }

  if(finalType !== "HOLD" && mtfHoldReasons.length){
    finalType = "HOLD";
  }

  const mtfInfo = {
    enabled: true,
    set: tfSet.slice(),
    alignLong, alignShort, alignHold,
    picked,
    alignScore,
    mtfEdge,
    perTF: perTF.map(x => ({
      tf: x.tf,
      ok: x.ok,
      type: x.ok ? x.sig.type : "NA",
      winProb: x.ok ? x.sig.explain?.winProbConservative : null
    })),
    holdReasons: mtfHoldReasons
  };

  const final = {
    ...base,
    type: finalType,
    explain: {
      ...(base.explain || {}),
      mtf: mtfInfo
    }
  };

  if(final.type === "HOLD"){
    const hr = (final.explain?.holdReasons || []).slice();
    for(const r of mtfHoldReasons) hr.push(r);
    final.explain.holdReasons = uniq(hr);
  }

  return finalizeSingleToDisplay(final);
}

/* ==========================================================
   G) ë‹¨ì¼ TF ë¶„ì„ (ìœ ì‚¬ë„ ê°•í™” + ìœŒìŠ¨ í•˜í•œ)
========================================================== */
function buildSignalFromCandlesOneTF(symbol, tf, candles){
  const closes = candles.map(x => x.c);
  const highs  = candles.map(x => x.h);
  const lows   = candles.map(x => x.l);
  const vols   = candles.map(x => x.v);

  const entry = closes[closes.length - 1];

  const rsi = calcRSI(closes, 14);
  const macd = calcMACD(closes);
  const atrRaw = calcATR(highs, lows, closes, 14);
  const volTrend = calcVolumeTrend(vols, 20);
  const ema20 = emaLast(closes, 20);
  const ema50 = emaLast(closes, 50);
  const trend = (ema20 >= ema50) ? 1 : -1;

  const sim = calcSimilarityStatsEnhanced(closes, highs, lows, vols, SIM_WINDOW, FUTURE_H, SIM_STEP, SIM_TOPK);

  const dom = (typeof state.btcDom === "number") ? state.btcDom : null;
  const domPrev = (typeof state.btcDomPrev === "number") ? state.btcDomPrev : null;
  const domUp = (dom !== null && domPrev !== null) ? (dom - domPrev) : 0;

  const isAlt = (symbol !== "BTCUSDT");
  let domDamp = 1.0;

  if(dom !== null){
    if(dom > 50) domDamp *= DOM_DAMP_BASE;
    if(domUp > 0.15) domDamp *= DOM_UP_PENALTY;
    if(isAlt && dom > 53) domDamp *= DOM_ALT_PENALTY;
  }

  // base probs from similarity (laplace)
  let longP = sim.longProb;
  let shortP = sim.shortProb;

  // tiny indicator bias
  const rsiBias   = clamp((50 - rsi) / 50, -1, 1);
  const macdBias  = clamp(macd.hist * 6, -1, 1);
  const volBias   = clamp(volTrend, -1, 1);
  const trendBias = clamp(trend * 0.8, -1, 1);

  longP  += (0.10 * rsiBias) + (0.08 * macdBias) + (0.05 * volBias) + (0.06 * trendBias);
  shortP += (-0.10 * rsiBias) + (-0.08 * macdBias) + (-0.05 * volBias) + (-0.06 * trendBias);

  // dominance pull to 0.5
  longP  = 0.5 + (longP - 0.5) * domDamp;
  shortP = 0.5 + (shortP - 0.5) * domDamp;

  // normalize
  const sum = Math.max(longP + shortP, 1e-9);
  longP /= sum; shortP /= sum;

  const typeRaw = (longP >= shortP) ? "LONG" : "SHORT";
  const winProb = Math.max(longP, shortP);
  const edge = Math.abs(longP - shortP);

  const successCount = (typeRaw === "LONG") ? sim.upCount : sim.downCount;
  const totalCount = sim.count;
  const winProbConservative = wilsonLowerBound(successCount, totalCount, WILSON_Z);

  // TP/SL
  const tfMult = TF_MULT[tf] || 1.2;
  const atrMin = entry * (ATR_MIN_PCT / 100);
  const atrUsed = Math.max(atrRaw, atrMin);

  let tpDist = atrUsed * tfMult;
  let slDist = tpDist / RR;

  let tp = (typeRaw === "LONG") ? (entry + tpDist) : (entry - tpDist);
  let sl = (typeRaw === "LONG") ? (entry - slDist) : (entry + slDist);

  let tpPct = Math.abs((tp - entry) / entry) * 100;
  let slPct = Math.abs((sl - entry) / entry) * 100;

  if(tpPct > TP_MAX_PCT){
    tpPct = TP_MAX_PCT;
    const newTpDist = entry * (tpPct/100);
    tp = (typeRaw === "LONG") ? (entry + newTpDist) : (entry - newTpDist);
    sl = (typeRaw === "LONG") ? (entry - (newTpDist/RR)) : (entry + (newTpDist/RR));
    slPct = Math.abs((sl - entry) / entry) * 100;
  }

  const holdReasons = [];
  if(sim.count < HOLD_MIN_TOPK) holdReasons.push(`ìœ ì‚¬íŒ¨í„´ í‘œë³¸ ë¶€ì¡±(${sim.count}ê°œ)`);
  if(sim.avgSim < HOLD_MIN_SIM_AVG) holdReasons.push(`ìœ ì‚¬ë„ í‰ê·  ë‚®ìŒ(${sim.avgSim.toFixed(1)}%)`);
  if(edge < HOLD_MIN_EDGE) holdReasons.push(`ë¡±/ìˆ ì°¨ì´ ì‘ìŒ(ì—£ì§€ ${(edge*100).toFixed(1)}%)`);
  if(tpPct < HOLD_MIN_TP_PCT) holdReasons.push(`ëª©í‘œìˆ˜ìµ ë„ˆë¬´ ì‘ìŒ(+${tpPct.toFixed(2)}%)`);
  if(winProbConservative < MIN_WINPROB_TO_TRADE) holdReasons.push(`ë³´ìˆ˜í™•ë¥  ë‚®ìŒ(${(winProbConservative*100).toFixed(1)}%)`);
  if(volTrend < -0.25) holdReasons.push(`ê±°ë˜ëŸ‰ íë¦„ ì•½í•¨(ì‹ ë¢°â†“)`);

  const isHold = holdReasons.length > 0;

  return {
    id: Date.now(),
    symbol,
    tf: tf === "60" ? "1H" : tf === "240" ? "4H" : "1D",
    tfRaw: tf,
    type: isHold ? "HOLD" : typeRaw,
    entry,
    tp: isHold ? null : tp,
    sl: isHold ? null : sl,
    tpPct: isHold ? null : tpPct,
    slPct: isHold ? null : slPct,
    createdAt: Date.now(),
    explain: {
      winProb,
      winProbConservative,
      longP, shortP,
      edge,
      simAvg: sim.avgSim,
      simCount: sim.count,
      upCount: sim.upCount,
      downCount: sim.downCount,
      rsi,
      macdHist: macd.hist,
      atr: atrUsed,
      volTrend,
      ema20, ema50,
      trend,
      btcDom: dom,
      btcDomUp: domUp,
      holdReasons
    }
  };
}

/* ==========================================================
   H) ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ
========================================================== */
let tempPos = null;

function showResultModal(pos){
  tempPos = pos;

  const modal = document.getElementById("result-modal");
  const icon = document.getElementById("modal-icon");
  const title = document.getElementById("modal-title");
  const subtitle = document.getElementById("modal-subtitle");
  const grid = document.getElementById("modal-grid");
  const content = document.getElementById("modal-content");
  const confirmBtn = document.getElementById("modal-confirm");

  const isLong = pos.type === "LONG";
  const isHold = pos.type === "HOLD";

  icon.textContent = isHold ? "â¸ï¸" : (isLong ? "ğŸ“ˆ" : "ğŸ“‰");
  title.textContent = isHold ? "HOLD (ë³´ë¥˜)" : `${pos.type} SIGNAL`;
  title.style.color = isHold ? "var(--text-sub)" : (isLong ? "var(--success)" : "var(--danger)");
  subtitle.textContent = `${pos.symbol} | ${pos.tf}`;

  const ex = pos.explain || {};
  const mtf = ex.mtf || null;

  if(isHold){
    const reasons = (ex.holdReasons || []).map(r => `- ${escapeHTML(r)}`).join("<br/>");

    grid.innerHTML = `
      <div class="mini-box"><small>íŒì •</small><div>ì´ë²ˆì—ëŠ” ì˜ˆì¸¡ ì•ˆ í•¨</div></div>
      <div class="mini-box"><small>ë³´ìˆ˜í™•ë¥ </small><div>${((ex.winProbConservative ?? 0)*100).toFixed(1)}%</div></div>
      <div class="mini-box"><small>ìœ ì‚¬ë„ í‰ê· </small><div>${(ex.simAvg ?? 0).toFixed(1)}%</div></div>
      <div class="mini-box"><small>í‘œë³¸ ìˆ˜</small><div>${ex.simCount ?? 0}ê°œ</div></div>
    `;

    let mtfLine = "";
    if(mtf?.enabled){
      mtfLine = `
        <br/><br/><b>MTF(íƒ€ì„í”„ë ˆì„ í•©ì˜):</b><br/>
        - LONG ${(mtf.alignLong*100).toFixed(0)}% / SHORT ${(mtf.alignShort*100).toFixed(0)}% / HOLD ${(mtf.alignHold*100).toFixed(0)}%<br/>
        - í•©ì˜ì ìˆ˜ ${(mtf.alignScore*100).toFixed(0)}% Â· ì—£ì§€ ${(mtf.mtfEdge*100).toFixed(1)}%<br/>
      `;
    }

    content.innerHTML = `
      <b>ì´ë²ˆì—ëŠ” â€œë³´ë¥˜â€ê°€ ë” ì•ˆì „í•´ìš”.</b><br/>
      ${reasons}
      ${mtfLine}
      <br/><br/>
      <b>ì •ë¦¬:</b> ì• ë§¤í•  ë•Œ ì–µì§€ë¡œ ì§„ì…í•˜ë©´ ì¥ê¸° ìŠ¹ë¥ ì´ ë‚´ë ¤ê°€ì„œ, ì´ë²ˆì€ íŒ¨ìŠ¤í•©ë‹ˆë‹¤.
    `;

    confirmBtn.disabled = true;
    confirmBtn.textContent = "ë³´ë¥˜ëŠ” ë“±ë¡í•˜ì§€ ì•ŠìŒ";
  }else{
    grid.innerHTML = `
      <div class="mini-box"><small>ì§„ì…ê°€</small><div>$${pos.entry.toLocaleString(undefined,{maximumFractionDigits:6})}</div></div>
      <div class="mini-box"><small>ë³´ìˆ˜í™•ë¥ </small><div>${((ex.winProbConservative ?? ex.winProb ?? 0)*100).toFixed(1)}%</div></div>
      <div class="mini-box"><small>ëª©í‘œê°€(TP)</small><div style="color:var(--success)">$${pos.tp.toLocaleString(undefined,{maximumFractionDigits:6})} (+${pos.tpPct.toFixed(2)}%)</div></div>
      <div class="mini-box"><small>ì†ì ˆê°€(SL)</small><div style="color:var(--danger)">$${pos.sl.toLocaleString(undefined,{maximumFractionDigits:6})} (-${pos.slPct.toFixed(2)}%)</div></div>
    `;

    const domMsg = (typeof ex.btcDom === "number")
      ? `BTC ë„ë¯¸ë„ŒìŠ¤ ${ex.btcDom.toFixed(1)}% (ìµœê·¼ ${ex.btcDomUp>=0?"+":""}${ex.btcDomUp.toFixed(2)}p)`
      : `BTC ë„ë¯¸ë„ŒìŠ¤: ë°ì´í„° ì—†ìŒ`;

    let mtfMsg = "";
    if(mtf?.enabled){
      mtfMsg = `
        <br/>
        <b>MTF í•©ì˜:</b>
        LONG ${(mtf.alignLong*100).toFixed(0)}% / SHORT ${(mtf.alignShort*100).toFixed(0)}% / HOLD ${(mtf.alignHold*100).toFixed(0)}%
        (í•©ì˜ ${(mtf.alignScore*100).toFixed(0)}%)
      `;
    }

    content.innerHTML = `
      <b>ê·¼ê±° ìš”ì•½:</b><br/>
      - ìœ ì‚¬íŒ¨í„´ ${ex.simCount ?? "-"}ê°œ Â· í‰ê·  ìœ ì‚¬ë„ ${(ex.simAvg ?? 0).toFixed(1)}%<br/>
      - ë³´ìˆ˜í™•ë¥  ${((ex.winProbConservative ?? 0)*100).toFixed(1)}% Â· ì—£ì§€ ${(ex.edge*100).toFixed(1)}%<br/>
      - RSI ${(ex.rsi ?? 0).toFixed(1)} Â· MACD ${(ex.macdHist ?? 0).toFixed(4)}<br/>
      - ì¶”ì„¸(EMA20/EMA50) ${(ex.ema20 ?? 0) >= (ex.ema50 ?? 0) ? "ìƒìŠ¹ ìš°ìœ„" : "í•˜ë½ ìš°ìœ„"}<br/>
      - ê±°ë˜ëŸ‰ íë¦„ ${(ex.volTrend ?? 0) >= 0 ? "ì¦ê°€" : "ê°ì†Œ"}<br/>
      - ${domMsg}
      ${mtfMsg}
      <br/><br/>
      <b>ì •ë¦¬:</b> â€œë³´ìˆ˜í™•ë¥  + í•©ì˜â€ê¹Œì§€ í†µê³¼í•´ì„œ ${pos.type}ë§Œ ì œì•ˆí•©ë‹ˆë‹¤.
    `;

    confirmBtn.disabled = false;
    confirmBtn.textContent = "ì¶”ì  ì‹œìŠ¤í…œì— ë“±ë¡";
  }

  modal.style.display = "flex";
}

function closeModal(){
  document.getElementById("result-modal").style.display = "none";
  tempPos = null;
}

/* ==========================================================
   I) ì¶”ì  ë“±ë¡ + ì¶”ì /ì¢…ë£Œ/ê¸°ë¡/í†µê³„
========================================================== */
function confirmTrack(){
  if(!tempPos) return;
  if(tempPos.type === "HOLD") return;

  if(hasActivePosition(tempPos.symbol, tempPos.tfRaw)){
    alert("ì´ë¯¸ ê°™ì€ ì½”ì¸/ê°™ì€ ê¸°ê°„ì˜ ì¶”ì  í¬ì§€ì…˜ì´ ìˆìŠµë‹ˆë‹¤.");
    return;
  }

  state.activePositions = state.activePositions || [];
  state.activePositions.unshift({
    ...tempPos,
    status: "ACTIVE",
    lastPrice: tempPos.entry,
    pnl: 0
  });

  saveState();
  closeModal();
  renderTrackingList();
  renderClosedTrades();
  updateStatsUI();
}

// PART 1ì˜ ê°€ê²© ê°±ì‹ ì—ì„œ ì¶”ì ë„ ê°™ì´ ëŒë¦¬ë„ë¡ "í•¨ìˆ˜ ë®ì–´ì“°ê¸°"
const __updateCoinRowPart1 = updateCoinRow;
updateCoinRow = function(symbol, price, changePct, silent=false){
  __updateCoinRowPart1(symbol, price, changePct, silent);

  // ì‹¤ì‹œê°„ ì¶”ì  (í•´ë‹¹ ì‹¬ë³¼ë§Œ)
  try{
    if(price > 0) trackPositions(symbol, price);
  }catch(e){}
};

function trackPositions(symbol, currentPrice){
  if(!state.activePositions || !state.activePositions.length) return;

  let changed = false;

  for(let i = state.activePositions.length - 1; i >= 0; i--){
    const pos = state.activePositions[i];
    if(pos.symbol !== symbol) continue;

    pos.lastPrice = currentPrice;

    let pnl = 0;
    if(pos.type === "LONG"){
      pnl = ((currentPrice - pos.entry) / pos.entry) * 100;
    }else{
      pnl = ((pos.entry - currentPrice) / pos.entry) * 100;
    }
    pos.pnl = pnl;

    let close = false;
    let win = false;
    let exitPrice = null;
    let exitReason = "";

    if(pos.type === "LONG"){
      if(currentPrice >= pos.tp){ close = true; win = true; exitPrice = pos.tp; exitReason="TP"; }
      else if(currentPrice <= pos.sl){ close = true; win = false; exitPrice = pos.sl; exitReason="SL"; }
    }else{
      if(currentPrice <= pos.tp){ close = true; win = true; exitPrice = pos.tp; exitReason="TP"; }
      else if(currentPrice >= pos.sl){ close = true; win = false; exitPrice = pos.sl; exitReason="SL"; }
    }

    if(close){
      state.history = state.history || { total:0, win:0 };
      state.history.total++;
      if(win) state.history.win++;

      state.closedTrades = state.closedTrades || [];
      const record = {
        id: Date.now(),
        symbol: pos.symbol,
        tf: pos.tf,
        tfRaw: pos.tfRaw,
        type: pos.type,
        entry: pos.entry,
        exit: exitPrice ?? currentPrice,
        pnlPct: pnl,
        win,
        reason: exitReason,
        closedAt: Date.now()
      };
      state.closedTrades.unshift(record);
      state.closedTrades = state.closedTrades.slice(0, 30);

      state.activePositions.splice(i, 1);
      changed = true;

      alert(`[${pos.symbol} ${pos.tf}] ì¢…ë£Œ: ${win ? "ì„±ê³µ" : "ì‹¤íŒ¨"} (${exitReason}) / ìˆ˜ìµë¥  ${pnl.toFixed(2)}%`);
    }else{
      changed = true;
    }
  }

  if(changed){
    saveState();
    renderTrackingList();
    renderClosedTrades();
    updateStatsUI();
  }
}

function renderTrackingList(){
  const container = document.getElementById("tracking-container");
  const list = state.activePositions || [];

  if(!list.length){
    container.innerHTML = `
      <div style="text-align:center; padding:50px; color:var(--text-sub); font-weight:950;">
        <i class="fa-solid fa-radar" style="font-size:44px; opacity:.18;"></i><br><br>
        í˜„ì¬ ì¶”ì  ì¤‘ì¸ í¬ì§€ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.<br/>
        ì™¼ìª½ì—ì„œ ì½”ì¸ì„ ê³ ë¥´ê³  â€œAI ë¶„ì„â€ì„ ëˆŒëŸ¬ë³´ì„¸ìš”.
      </div>
    `;
    return;
  }

  // âœ… PART 1 CSSì— ì—†ëŠ” ì¹´ë“œ ìŠ¤íƒ€ì¼ì´ë¯€ë¡œ, ìµœì†Œ ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ë¡œ ë Œë”
  container.innerHTML = list.map(pos => {
    const isUp = (pos.pnl ?? 0) >= 0;
    const color = isUp ? "var(--success)" : "var(--danger)";

    const denom = Math.max(Math.abs((pos.tp ?? pos.entry) - pos.entry), 1e-9);
    const numer = (pos.type === "LONG")
      ? ((pos.lastPrice ?? pos.entry) - pos.entry)
      : (pos.entry - (pos.lastPrice ?? pos.entry));

    let progress = (numer / denom) * 100;
    progress = clamp(progress, 0, 100);

    const ex = pos.explain || {};
    const mtf = ex.mtf || null;

    const explainLine =
      `ìœ ì‚¬ ${ex.simCount ?? "-"}ê°œ Â· ìœ ì‚¬ë„ ${(ex.simAvg ?? 0).toFixed(1)}% Â· ë³´ìˆ˜í™•ë¥  ${((ex.winProbConservative ?? 0)*100).toFixed(1)}% Â· ì—£ì§€ ${((ex.edge ?? 0)*100).toFixed(1)}%` +
      (mtf?.enabled ? ` Â· í•©ì˜ ${(mtf.alignScore*100).toFixed(0)}%` : "");

    return `
      <div style="background:#fff; border:1px solid var(--border); border-radius:16px; padding:14px; margin-bottom:12px; box-shadow:0 2px 8px rgba(0,0,0,.03);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <div style="font-weight:950;">${pos.symbol} <span style="font-size:12px; color:var(--text-sub); font-weight:950;">${pos.tf}</span></div>
          <div style="font-weight:950; padding:4px 10px; border-radius:999px; border:1px solid var(--border); background:var(--secondary); color:${pos.type==="LONG"?"var(--success)":"var(--danger)"};">
            ${pos.type}
          </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1.2fr 1fr; gap:10px; align-items:center;">
          <div>
            <div style="font-size:11px; color:var(--text-sub); font-weight:900;">í˜„ì¬ê°€</div>
            <div style="font-weight:950;">$${(pos.lastPrice||pos.entry).toLocaleString(undefined,{maximumFractionDigits:6})}</div>
          </div>

          <div>
            <div style="display:flex; justify-content:space-between; font-size:12px; font-weight:900; margin-bottom:6px;">
              <span style="color:${color};">ìˆ˜ìµë¥  ${(pos.pnl ?? 0).toFixed(2)}%</span>
              <span style="color:var(--text-sub);">ëª©í‘œê¹Œì§€ ${progress.toFixed(1)}%</span>
            </div>
            <div style="height:10px; background:var(--border); border-radius:999px; overflow:hidden;">
              <div style="height:10px; width:${progress}%; background:${color};"></div>
            </div>
          </div>

          <div style="text-align:right;">
            <div style="font-size:11px; color:var(--text-sub); font-weight:900;">TP / SL</div>
            <div style="font-weight:950; color:var(--success);">$${(pos.tp ?? pos.entry).toLocaleString(undefined,{maximumFractionDigits:6})}</div>
            <div style="font-weight:950; color:var(--danger);">$${(pos.sl ?? pos.entry).toLocaleString(undefined,{maximumFractionDigits:6})}</div>
          </div>
        </div>

        <div style="margin-top:10px; font-size:11px; color:var(--text-sub); font-weight:900;">${escapeHTML(explainLine)}</div>
      </div>
    `;
  }).join("");
}

function renderClosedTrades(){
  const container = document.getElementById("history-container");
  const countEl = document.getElementById("history-count");
  const list = state.closedTrades || [];
  if(countEl) countEl.textContent = String(list.length);

  if(!list.length){
    container.innerHTML = `
      <div style="font-size:11px; color:var(--text-sub); font-weight:900; padding:4px 2px;">
        ì•„ì§ ì¢…ë£Œëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.
      </div>
    `;
    return;
  }

  container.innerHTML = list.slice(0, 8).map(x => {
    const badge = x.win ? `<span class="badge-win">ì„±ê³µ</span>` : `<span class="badge-lose">ì‹¤íŒ¨</span>`;
    const pnlColor = x.pnlPct >= 0 ? "var(--success)" : "var(--danger)";
    return `
      <div class="history-item">
        <div class="left">
          ${badge}
          <span>${x.symbol.replace("USDT","")} ${x.tf}</span>
          <span style="color:var(--text-sub); font-weight:950;">(${x.reason})</span>
        </div>
        <div style="text-align:right;">
          <div style="color:${pnlColor}; font-weight:950;">${x.pnlPct.toFixed(2)}%</div>
          <div style="color:var(--text-sub); font-size:10px; font-weight:900;">
            ${new Date(x.closedAt).toLocaleTimeString()}
          </div>
        </div>
      </div>
    `;
  }).join("");
}

function updateStatsUI(){
  const totalEl = document.getElementById("total-stat");
  const winEl = document.getElementById("win-stat");
  const actEl = document.getElementById("active-stat");

  state.history = state.history || { total:0, win:0 };
  const total = state.history.total || 0;
  const win = state.history.win || 0;
  const rate = total > 0 ? (win / total) * 100 : 0;

  if(totalEl) totalEl.innerText = total;
  if(winEl) winEl.innerText = `${rate.toFixed(1)}%`;
  if(actEl) actEl.innerText = (state.activePositions || []).length;
}

/* ==========================================================
   J) ë°±í…ŒìŠ¤íŠ¸(runBacktest) - ê°•í™”í˜•
========================================================== */
async function runBacktest(){
  const btBtn = document.getElementById("bt-btn");
  btBtn.disabled = true;
  btBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ë°±í…ŒìŠ¤íŠ¸...';

  try{
    const candles = await fetchCandles(state.symbol, state.tf, EXTENDED_LIMIT);
    if(candles.length < (SIM_WINDOW + FUTURE_H + 120)) throw new Error("ìº”ë“¤ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");

    let wins=0, total=0;
    let pnlSum=0;

    const end = candles.length - (FUTURE_H + 20);
    const start = Math.max(SIM_WINDOW + 80, end - (BACKTEST_TRADES * 7));

    for(let idx = start; idx < end; idx += 7){
      const pos = await buildFinalSignalMTFBacktest(state.symbol, state.tf, candles, idx);
      if(pos.type === "HOLD") continue;

      const ex = pos.explain || {};
      const mtf = ex.mtf || null;

      const p = ex.winProbConservative ?? 0;
      const edge = ex.edge ?? 0;
      const simAvg = ex.simAvg ?? 0;
      const align = mtf?.enabled ? (mtf.alignScore ?? 0) : 0;

      if(p < BT_MIN_PROB) continue;
      if(edge < BT_MIN_EDGE) continue;
      if(simAvg < BT_MIN_SIM) continue;
      if(mtf?.enabled && align < BT_MIN_ALIGN) continue;

      const future = candles.slice(idx+1, Math.min(idx+1+140, candles.length));
      const outcome = simulateOutcome(pos, future);
      if(!outcome.resolved) continue;

      total++;
      if(outcome.win) wins++;
      pnlSum += outcome.pnlPct;

      if(total >= BACKTEST_TRADES) break;
    }

    const winRate = total ? (wins/total)*100 : 0;
    const avgPnl = total ? (pnlSum/total) : 0;

    alert(
      `ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼\n` +
      `- íšŸìˆ˜: ${total}íšŒ\n` +
      `- ìŠ¹ë¥ : ${winRate.toFixed(1)}%\n` +
      `- í‰ê· ìˆ˜ìµ: ${avgPnl.toFixed(2)}%\n\n` +
      `í•„í„°: ë³´ìˆ˜í™•ë¥ â‰¥${Math.round(BT_MIN_PROB*100)}%, ì—£ì§€â‰¥${Math.round(BT_MIN_EDGE*100)}%, ìœ ì‚¬ë„â‰¥${BT_MIN_SIM}%, í•©ì˜â‰¥${Math.round(BT_MIN_ALIGN*100)}%`
    );
  }catch(e){
    console.error(e);
    alert("ë°±í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }finally{
    btBtn.disabled = false;
    btBtn.innerHTML = '<i class="fa-solid fa-flask"></i> ë°±í…ŒìŠ¤íŠ¸';
  }
}

async function buildFinalSignalMTFBacktest(symbol, tfRaw, fullCandlesForSelectedTF, idx){
  const tfSet = MTF_SET[tfRaw] || [tfRaw];
  const weights = MTF_WEIGHT[tfRaw] || { [tfRaw]:1.0 };

  const btTFSet = tfSet.slice(0, 2); // ì„±ëŠ¥ ë³´í˜¸: 2ê°œ TFë§Œ
  const perTF = [];

  for(const tf of btTFSet){
    if(tf === tfRaw){
      const slice = fullCandlesForSelectedTF.slice(0, idx+1);
      const s = buildSignalFromCandlesOneTF(symbol, tf, slice);
      perTF.push({ tf, ok:true, sig:s });
      continue;
    }

    const candles = await fetchCandles(symbol, tf, EXTENDED_LIMIT);
    const targetT = fullCandlesForSelectedTF[Math.max(0, idx)]?.t ?? 0;
    const cut = candles.filter(c => c.t <= targetT);
    if(cut.length < (SIM_WINDOW + FUTURE_H + 80)){
      perTF.push({ tf, ok:false, reason:"ìº”ë“¤ ë¶€ì¡±" });
      continue;
    }
    const s = buildSignalFromCandlesOneTF(symbol, tf, cut);
    perTF.push({ tf, ok:true, sig:s });
  }

  const valid = perTF.filter(x=>x.ok).map(x=>x.sig);
  if(valid.length === 0) return buildSignalFromCandlesOneTF(symbol, tfRaw, fullCandlesForSelectedTF.slice(0, idx+1));
  if(!MTF_ENABLED || valid.length === 1) return finalizeSingleToDisplay(valid[0]);

  let longScore = 0, shortScore = 0, holdHits = 0;
  for(const item of perTF){
    if(!item.ok) continue;
    const w = weights[item.tf] ?? 0.2;
    const sig = item.sig;
    if(sig.type === "HOLD"){ holdHits += w; continue; }
    if(sig.type === "LONG") longScore += w;
    else if(sig.type === "SHORT") shortScore += w;
  }

  const totalScore = longScore + shortScore + holdHits + 1e-9;
  const alignLong = longScore / totalScore;
  const alignShort = shortScore / totalScore;
  const alignHold = holdHits / totalScore;

  const picked = (alignLong >= alignShort) ? "LONG" : "SHORT";
  const alignScore = Math.max(alignLong, alignShort);
  const mtfEdge = Math.abs(alignLong - alignShort);

  const mtfHoldReasons = [];
  if(alignHold >= 0.34) mtfHoldReasons.push(`ì—¬ëŸ¬ TFê°€ ë³´ë¥˜`);
  if(alignScore < MTF_MIN_ALIGN_SCORE) mtfHoldReasons.push(`í•©ì˜ ë¶€ì¡±`);
  if(mtfEdge < MTF_MIN_EDGE) mtfHoldReasons.push(`í•©ì˜ ì—£ì§€ ë¶€ì¡±`);

  const base = valid.find(x=>x.tfRaw===tfRaw) || valid[0];
  let finalType = base.type;

  if(finalType !== "HOLD"){
    const oppositeStrong = (picked !== finalType) && (alignScore >= 0.72);
    if(MTF_DISAGREE_HOLD && oppositeStrong){
      finalType = "HOLD";
      mtfHoldReasons.push(`MTF ê°•í•œ ë°˜ëŒ€`);
    }
  }
  if(finalType !== "HOLD" && mtfHoldReasons.length) finalType = "HOLD";

  const mtfInfo = {
    enabled: true,
    set: btTFSet.slice(),
    alignLong, alignShort, alignHold,
    picked,
    alignScore,
    mtfEdge,
    holdReasons: mtfHoldReasons
  };

  const final = {
    ...base,
    type: finalType,
    explain: {
      ...(base.explain || {}),
      mtf: mtfInfo
    }
  };

  if(final.type === "HOLD"){
    const hr = (final.explain?.holdReasons || []).slice();
    for(const r of mtfHoldReasons) hr.push(r);
    final.explain.holdReasons = uniq(hr);
  }

  return finalizeSingleToDisplay(final);
}

function simulateOutcome(pos, futureCandles){
  for(const c of futureCandles){
    const hi = c.h, lo = c.l;
    if(pos.type === "LONG"){
      if(hi >= pos.tp){
        const pnl = ((pos.tp - pos.entry)/pos.entry)*100;
        return { resolved:true, win:true, pnlPct:pnl };
      }
      if(lo <= pos.sl){
        const pnl = ((pos.sl - pos.entry)/pos.entry)*100;
        return { resolved:true, win:false, pnlPct:pnl };
      }
    }else{
      if(lo <= pos.tp){
        const pnl = ((pos.entry - pos.tp)/pos.entry)*100;
        return { resolved:true, win:true, pnlPct:pnl };
      }
      if(hi >= pos.sl){
        const pnl = ((pos.entry - pos.sl)/pos.entry)*100;
        return { resolved:true, win:false, pnlPct:pnl };
      }
    }
  }
  return { resolved:false, win:false, pnlPct:0 };
}

/* ==========================================================
   K) ìº”ë“¤ Fetch
========================================================== */
async function fetchCandles(symbol, tf, limit){
  const res = await fetchJSON(BYBIT_KLINE(symbol, tf, limit), { timeoutMs: 9000, retry: 1 });
  const kline = res?.result?.list || [];
  const candles = kline.map(row => ({
    t: Number(row[0]),
    o: parseFloat(row[1]),
    h: parseFloat(row[2]),
    l: parseFloat(row[3]),
    c: parseFloat(row[4]),
    v: parseFloat(row[5])
  })).filter(x => Number.isFinite(x.t) && Number.isFinite(x.c) && Number.isFinite(x.h) && Number.isFinite(x.l));
  candles.sort((a,b)=> a.t - b.t);
  return candles;
}

/* ==========================================================
   L) ìœ ì‚¬ë„ ì—”ì§„ ê°•í™”(ë¦¬í„´ + ATR% + ë³¼ë¥¨ë³€í™”)
========================================================== */
function calcSimilarityStatsEnhanced(closes, highs, lows, vols, winLen, futureH, step, topK){
  const n = closes.length;
  const curStart = n - winLen;
  const curClose = closes.slice(curStart, n);
  const curHigh  = highs.slice(curStart, n);
  const curLow   = lows.slice(curStart, n);
  const curVol   = vols.slice(curStart, n);

  const curRet = returns(curClose);
  const curAtrP = atrPctSeries(curHigh, curLow, curClose, 14);
  const curVolChg = volChangeSeries(curVol);

  const sims = [];
  const lastStart = n - winLen - futureH - 2;

  for(let s=0; s<=lastStart; s+=step){
    const segClose = closes.slice(s, s + winLen);
    const segHigh  = highs.slice(s, s + winLen);
    const segLow   = lows.slice(s, s + winLen);
    const segVol   = vols.slice(s, s + winLen);

    const ret = returns(segClose);
    const atrp = atrPctSeries(segHigh, segLow, segClose, 14);
    const vchg = volChangeSeries(segVol);

    const simRet  = zncc(curRet, ret);
    const simAtr  = zncc(curAtrP, atrp);
    const simVol  = zncc(curVolChg, vchg);

    if(!Number.isFinite(simRet) || !Number.isFinite(simAtr) || !Number.isFinite(simVol)) continue;

    const sim = (0.62 * simRet) + (0.25 * simAtr) + (0.13 * simVol);

    const entry = closes[s + winLen - 1];
    const future = closes[s + winLen - 1 + futureH];
    const r = (future - entry) / Math.max(entry, 1e-12);

    sims.push({ sim, r });
  }

  sims.sort((a,b)=> b.sim - a.sim);
  const top = sims.slice(0, Math.min(topK, sims.length));

  const count = top.length;
  if(count === 0){
    return { longProb: 0.5, shortProb: 0.5, avgSim: 0, count: 0, upCount:0, downCount:0 };
  }

  const upCount = top.filter(x => x.r >= 0).length;
  const downCount = count - upCount;

  const longProb = (upCount + 1) / (count + 2);
  const shortProb = (downCount + 1) / (count + 2);

  const avgZ = top.reduce((a,b)=>a+b.sim,0) / count;
  const avgSim = clamp((avgZ + 1) * 50, 0, 100);

  return { longProb, shortProb, avgSim, count, upCount, downCount };
}

function atrPctSeries(highSeg, lowSeg, closeSeg, period=14){
  const n = closeSeg.length;
  if(n < 6) return Array(Math.max(n-1,0)).fill(0);

  const trs = [];
  for(let i=1;i<n;i++){
    const h = highSeg[i], l = lowSeg[i], pc = closeSeg[i-1];
    const tr = Math.max(h-l, Math.abs(h-pc), Math.abs(l-pc));
    trs.push(tr);
  }

  const out = [];
  for(let i=0;i<trs.length;i++){
    const start = Math.max(0, i - period + 1);
    const slice = trs.slice(start, i+1);
    const atr = slice.reduce((a,b)=>a+b,0) / Math.max(slice.length,1);
    const pct = atr / Math.max(closeSeg[i+1], 1e-12);
    out.push(pct);
  }
  return out;
}

function volChangeSeries(volSeg){
  const out = [];
  for(let i=1;i<volSeg.length;i++){
    const prev = Math.max(volSeg[i-1], 1e-12);
    out.push((volSeg[i] - volSeg[i-1]) / prev);
  }
  return out;
}

/* ==========================================================
   M) ìœŒìŠ¨ í•˜í•œ(ë³´ìˆ˜ í™•ë¥ )
========================================================== */
function wilsonLowerBound(success, total, z=1.64){
  if(total <= 0) return 0;
  const n = total;
  const phat = success / n;

  const z2 = z*z;
  const denom = 1 + (z2/n);
  const center = phat + (z2/(2*n));
  const margin = z * Math.sqrt((phat*(1-phat) + (z2/(4*n))) / n);

  return clamp((center - margin) / denom, 0, 1);
}

/* ==========================================================
   N) ë§ˆë¬´ë¦¬ ë³´ì •
========================================================== */
function finalizeSingleToDisplay(sig){
  if(sig.type !== "HOLD"){
    if(!(Number.isFinite(sig.tp) && Number.isFinite(sig.sl))){
      sig.type = "HOLD";
      sig.tp = null; sig.sl = null; sig.tpPct = null; sig.slPct = null;
      sig.explain = sig.explain || {};
      sig.explain.holdReasons = uniq([...(sig.explain.holdReasons||[]), "TP/SL ê³„ì‚° ì‹¤íŒ¨(ë³´ë¥˜)"]);
    }
  }
  sig.tf = sig.tfRaw === "60" ? "1H" : sig.tfRaw === "240" ? "4H" : "1D";
  return sig;
}

/* ==========================================================
   O) Protections
========================================================== */
function hasActivePosition(symbol, tfRaw){
  return (state.activePositions || []).some(p => p.symbol === symbol && p.tfRaw === tfRaw);
}

function isInCooldown(key){
  const last = state.lastSignalAt?.[key] || 0;
  const cd = COOLDOWN_MS[state.tf] || (10*60*1000);
  return (Date.now() - last) < cd;
}

/* ==========================================================
   P) Indicators / Similarity Utils
========================================================== */
function returns(seg){
  const out = [];
  for(let i=1;i<seg.length;i++){
    out.push((seg[i] - seg[i-1]) / Math.max(seg[i-1], 1e-12));
  }
  return out;
}

function zncc(a,b){
  const m = Math.min(a.length, b.length);
  if(m < 5) return 0;

  const a0 = a.slice(0,m);
  const b0 = b.slice(0,m);

  const ma = mean(a0), mb = mean(b0);
  let sa = 0, sb = 0;
  for(let i=0;i<m;i++){
    sa += (a0[i]-ma)*(a0[i]-ma);
    sb += (b0[i]-mb)*(b0[i]-mb);
  }
  sa = Math.sqrt(sa / m);
  sb = Math.sqrt(sb / m);
  if(sa === 0 || sb === 0) return 0;

  let dot = 0;
  for(let i=0;i<m;i++){
    dot += ((a0[i]-ma)/sa) * ((b0[i]-mb)/sb);
  }
  return dot / m;
}

function mean(arr){
  return arr.reduce((a,b)=>a+b,0) / Math.max(arr.length,1);
}

function calcRSI(closes, period=14){
  if(closes.length < period+1) return 50;
  let gains = 0, losses = 0;
  for(let i = closes.length - period - 1; i < closes.length - 1; i++){
    const diff = closes[i+1] - closes[i];
    if(diff >= 0) gains += diff;
    else losses -= diff;
  }
  if(losses === 0) return 100;
  const rs = gains / losses;
  return 100 - (100 / (1 + rs));
}

function ema(values, period){
  const k = 2 / (period + 1);
  let prev = values[0];
  const out = [prev];
  for(let i=1;i<values.length;i++){
    prev = values[i]*k + prev*(1-k);
    out.push(prev);
  }
  return out;
}

function emaLast(values, period){
  if(values.length < period) return values[values.length-1] || 0;
  const e = ema(values.slice(-Math.max(period*3, period+5)), period);
  return e[e.length-1];
}

function calcMACD(closes){
  if(closes.length < 60) return { macd:0, signal:0, hist:0 };
  const e12 = ema(closes, 12);
  const e26 = ema(closes, 26);
  const macdLine = e12.map((v,i)=> v - e26[i]);
  const signalLine = ema(macdLine, 9);
  const macd = macdLine[macdLine.length-1];
  const signal = signalLine[signalLine.length-1];
  const hist = macd - signal;
  return { macd, signal, hist };
}

function calcATR(highs, lows, closes, period=14){
  if(closes.length < period+1) return 0;
  const trs = [];
  for(let i=1;i<closes.length;i++){
    const h = highs[i], l = lows[i], pc = closes[i-1];
    const tr = Math.max(h-l, Math.abs(h-pc), Math.abs(l-pc));
    trs.push(tr);
  }
  const slice = trs.slice(-period);
  const sum = slice.reduce((a,b)=>a+b,0);
  return sum / Math.max(slice.length,1);
}

function calcVolumeTrend(vols, lookback=20){
  if(vols.length < lookback*2) return 0;
  const a = avg(vols.slice(-lookback));
  const b = avg(vols.slice(-(lookback*2), -lookback));
  if(b === 0) return 0;
  return (a - b) / b;
}

function avg(arr){
  if(!arr.length) return 0;
  return arr.reduce((a,b)=>a+b,0) / arr.length;
}

/* ==========================================================
   Q) Safe HTML / uniq
========================================================== */
function escapeHTML(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function uniq(arr){
  const out = [];
  const set = new Set();
  for(const x of arr){
    const k = String(x);
    if(set.has(k)) continue;
    set.add(k);
    out.push(x);
  }
  return out;
}

/* ==========================================================
   R) PART 2 ë¡œë”© ì§í›„: ì¶”ì²œ/ì¶”ì /í†µê³„ ë Œë”
========================================================== */
try{
  renderScanResults();
  renderTrackingList();
  renderClosedTrades();
  updateStatsUI();
}catch(e){}

</script>
<!-- =========================
  PART 2 END
========================= -->


</body>
</html>

